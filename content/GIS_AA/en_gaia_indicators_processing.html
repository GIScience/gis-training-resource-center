

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>GAIA Pipeline Documentation &#8212; GIS Resource Training Center</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/GIS_AA/en_gaia_indicators_processing';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Historical Impact Assessment (HIA) for Flood in Sudan" href="en_qgis_historical_impact_assessment_sudan.html" />
    <link rel="prev" title="How to generate Risk Indicators" href="en_qgis_generate_indicators_for_plugin.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">Looking to contribute? Take a look at the contribution guidelines and contact us!</div>
  </div>

  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/IFRC_Logo_Horizontal_RGB.svg" class="logo__image only-light" alt="GIS Resource Training Center - Home"/>
    <script>document.write(`<img src="../../_static/IFRC_Logo_Horizontal_RGB.svg" class="logo__image only-dark" alt="GIS Resource Training Center - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to the IFRC Network GIS Training Platform
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_1/en_module_1_overview.html">1. Introduction to GIS</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_1/en_qgis_theory.html">1.1. What is GIS?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_1/en_qgis_installation.html">1.2. Setting up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_1/en_qgis_start.html">1.3. Getting started with QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_1/en_qgis_module_1_exercises.html">1.4. Exercises for Module 1</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_2/en_module_2_overview.html">2. Working with Geodata</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_qgis_geodata_concept.html">2.1. Introduction to geodata and layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_qgis_projections.html">2.2. Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_qgis_geodata_management.html">2.3. Geodata management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_qgis_attribute_table.html">2.4. Attribute Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_data_sources.html">2.5. Data sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_qgis_basemap.html">2.6. Basemaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_2/en_qgis_module_2_exercises.html">2.7. Exercises for Module 2</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_3/en_module_3_overview.html">3. Basic GIS Operations</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_3/en_qgis_digitalisation.html">3.1. Digitisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_3/en_qgis_data_queries.html">3.2. Geodata Selection and Queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_3/en_qgis_data_classification.html">3.3. Geodata Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_3/en_qgis_georeferencing.html">3.4. Georeferencing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_3/en_qgis_module_3_exercises.html">3.5. Exercises for Module 3</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_4/en_module_4_overview.html">4. Visualisation of Geodata and Map Making</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_map_design_I.html">4.1. Symbology and Colours</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_styling_vector_data.html">4.2. Styling Vector Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_labels_vector.html">4.3. Labels for Vector Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_working_with_styles.html">4.4. Exporting and Importing Styles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_symbology_raster.html">4.5. Symbology for Raster Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_map_design_2.html">4.6. The Print layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_understanding_print_layout.html">4.7. Understanding the Print Layout Composer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_map_examples.html">4.8. Good Map Design &amp; Semiological Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_4/en_qgis_module_4_exercises.html">4.9. Exercises for Module 4</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_5/en_module_5_overview.html">5. Intermediate GIS Operations</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_5/en_qgis_spatial_tools.html">5.1. Spatial data processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_5/en_qgis_overlay_operations.html">5.2. Overlay Operations (Clip, Dissolve, Buffer)</a></li>

<li class="toctree-l2"><a class="reference internal" href="../Module_5/en_qgis_centroids.html">5.4. Centroids</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_5/en_qgis_non_spatial_tools.html">5.5. Non-Spatial processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_5/en_qgis_module_5_exercises.html">5.6. Exercises for Module 5</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_6/en_module_6_overview.html">6. Data Analysis with QGIS</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_6/en_qgis_data_analysis_theory.html">6.1. Data Analysis with QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_6/en_qgis_common_data_analysis.html">6.2. Data Analysis in the Humanitarian Sector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_6/en_qgis_module_6_exercises.html">6.3. Exercises Module 6 - Data Analysis with QGIS</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_7/en_module_7_overview.html">7. Automation with QGIS</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_7/en_qgis_automation_theory.html">7.1. The model designer in QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_7/en_qgis_module_7_exercises.html">7.2. Exercises for Module 7</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_8/en_module_8_overview.html">8. Remote Sensing and Raster Data</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_8/en_qgis_remote_sensing_raster_theory.html">8.1. Remote Sensing and Raster data theory 🛰️</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_8/en_qgis_raster_operations.html">8.2. Common Raster Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_8/en_qgis_remote_sensing_theory.html">8.3. Introduction to Remote Sensing and Remote Sensing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_8/en_qgis_module_8_ex1.html">8.4. Raster data Exercise 1: Basic Assessment of Flood Exposure in the Indus Basin in Pakistan</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Module_9/en_module_9_overview.html">9. Network Analysis</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Module_9/en_qgis_network_analysis_theory.html">9.1. Spatial Network Analysis Theory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_9/en_qgis_openrouteservice_tools.html">9.2. Plugin: Openrouteservice (ORS) tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_9/en_qgis_centrality.html">9.3. Network centrality measures and its application in QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Module_9/en_qgis_module_9_exercises.html">9.4. Exercises Module 9: Network Analysis</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exercises</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Exercise_tracks/en_exercise_tracks_overview.html">Exercise Overview</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Exercise_tracks/en_larkana_flood_response.html">Exercise Track: Larkana Flood Response</a></li>

<li class="toctree-l2"><a class="reference internal" href="../Exercise_tracks/en_mdg_aa_cyclones.html">Exercise Track: Anticipatory Action Analysis for Cyclones in Madagascar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Exercise_tracks/fr_mdg_aa_cyclones.html">Piste d’Exercice : Analyse d’Action Anticipative pour les Cyclones à Madagascar</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Wiki</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_qgis_basics_wiki.html">QGIS Basics</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_installation_wiki.html">QGIS installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_interface_wiki.html">QGIS Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_projects_folder_structure_wiki.html">Projects and Folder Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_projections_wiki.html">Projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_basemaps_wiki.html">Basemaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_plugins_wiki.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_data_sources_wiki.html">Data sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_licensing_data.html">Data Licenses (working with licensed datasets)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_geodata_wiki.html">Geodata</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_geodata_types_wiki.html">Types of Geodata</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_import_geodata_wiki.html">Geodata Import in QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_OpenStreetMap_wiki.html">OpenStreetMap (OSM) Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_layer_concept_wiki.html">Layer Concept</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_attribute_table_wiki.html">Attribute Table in QGIS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_digitisation_wiki.html">Digitisation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_data_classification_wiki.html">Geodata Classification</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_single_symbol_wiki.html">Single symbol classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_categorised_wiki.html">Categorised classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_graduated_wiki.html">Graduated classification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Wiki/en_qgis_geoprocessing_wiki.html">Geoprocessing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_queries_wiki.html">Spatial and Non-spatial queries</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_spatial_queries_wiki.html">Spatial Queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_non_spatial_queries_wiki.html">Non-Spatial Queries</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Wiki/en_qgis_table_functions_wiki.html">Manipulating the Attribute Table (Table functions)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_joins_wiki.html">Joining Geodata (Spatial and non-spatial joins)</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_spatial_joins_wiki.html">Spatial Joins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_non_spatial_joins_wiki.html">Non-Spatial Joins</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_raster_wiki.html">Raster</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_raster_basic_wiki.html">Basic Raster Operations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Wiki/en_qgis_automation_wiki.html">Automatisation in QGIS (The Model Builder)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Wiki/en_qgis_representation_wiki.html">Visualisation and Map Making in QGIS</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_visualisation_wiki.html">Visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Wiki/en_qgis_map_making_wiki.html">The Print Layout Composer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Wiki/en_qgis_common_errors_and_Issues.html">QGIS common errors and issues <!-- omit from toc --></a></li>

<li class="toctree-l1"><a class="reference internal" href="../Wiki/en_web_and_mobile_apps_wiki.html">Web &amp; mobile GIS applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Wiki/en_geodata_management_sharepoint.html">Geodata Management with Sharepoint</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GIS in Anticipatory Action</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="en_qgis_cyclone_trigger_madagascar.html">QGIS Trigger Workflow for Madagascar</a></li>


<li class="toctree-l1"><a class="reference internal" href="en_qgis_drought_trigger_somalia.html">QGIS Trigger Workflow for Somalia</a></li>


<li class="toctree-l1 has-children"><a class="reference internal" href="en_AILAS_madagascar.html">AI Logistic Awareness System (AILAS) Street level image collection Field Experiments</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="en_AILAS_madagascar_camera_usage_guide.html">Camera Usage Guide: AILAS Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="en_AILAS_madagascar_picture_upload_and_management.html">Picture upload and management: AILAS Project</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="fr_AILAS_madagascar.html">Système de conscience siuationelle logistique par IA (AILAS): Expérimentations de terrain pour la collecte d’images au niveau de la rue</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="fr_AILAS_madagascar_camera_usage_guide.html">Guide d’utilisation de la caméra: projet AILAS</a></li>
<li class="toctree-l2"><a class="reference internal" href="fr_AILAS_madagascar_picture_upload_and_management.html">Téléversement et gestion des images : Projet AILAS</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="en_qgis_risk_assessment_plugin.html">Risk Assessment QGIS Plugin</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="en_qgis_generate_indicators_for_plugin.html">How to generate Risk Indicators</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">GAIA Pipeline Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="en_qgis_historical_impact_assessment_sudan.html">Historical Impact Assessment (HIA) for Flood in Sudan</a></li>

<li class="toctree-l1"><a class="reference internal" href="en_qgis_GIS_AA_exercises.html">Exercises - GIS in Anticipatory Action</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mobile Data Collection</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Mobile_Data_collection/en_SMT.html">Sketch Map Tool</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Mobile_Data_collection/en_SMT_training.html">Sketch Map Tool Training</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Mobile_Data_collection/en_SMT_ex1_.html">Sketch Map Tool Exercise 1 - Workflow Exercise</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Mobile_Data_collection/en_SMT_ex2_.html">Sketch Map Tool Exercise 2 - Traffic light</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Mobile_Data_collection/en_SMT_ex3_.html">Sketch Map Tool Exercise 3 - Role Play using the Sketch Map Tool in EVCA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Mobile_Data_collection/en_SMT_ex4_.html">Sketch Map Tool Exercise 4 - Basic Visualization of the results in QGIS &amp; uMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Mobile_Data_collection/en_SMT_ex5_.html">Sketch Map Tool Exercise 5 - Heat Map Visualization</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Trainers corner</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Trainers_corner/en_TOT_intro.html">Train of trainers introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Trainers_corner/en_how_to_training.html">How to plan a whole GIS Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Trainers_corner/en_training_graphical_outline.html">Training Agenda and Handout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Trainers_corner/en_training_day_structure.html">How to plan and structure a GIS Training Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Trainers_corner/en_how_to_teach_GIS.html">How to teach GIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Trainers_corner/en_how_to_assessment.html">Assessments in GIS Training: A Guide</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../About/about_1.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribution_plan.html">Contribution Plan for the IFRC GIS Training Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Glossary/en_glossary_1.html">Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/GIScience/gis-training-resource-center" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/GIScience/gis-training-resource-center/issues/new?title=Issue%20on%20page%20%2Fcontent/GIS_AA/en_gaia_indicators_processing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/content/GIS_AA/en_gaia_indicators_processing.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>GAIA Pipeline Documentation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-countries">Available Countries:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-assessment-plugin">Risk Assessment Plugin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-to-services">1. Access to Services</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-sources">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-steps">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outputs">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#facilities">2. Facilities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coping-capacity">3. Coping Capacity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demographics">4. Demographics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#indicators">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rural-population">5. Rural Population</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vulnerability">6. Vulnerability</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crop-coverage-and-change">7. Crop Coverage and Change</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vegetation-index">8. Vegetation Index</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ndvi-thresholds">NDVI Thresholds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flood-exposure">9. Flood Exposure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flood-threshold">Flood Threshold</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Outputs</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="gaia-pipeline-documentation">
<h1>GAIA Pipeline Documentation<a class="headerlink" href="#gaia-pipeline-documentation" title="Permalink to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>The Global Aggregation of Indicators for Anticipatory Action (GAIA) Pipeline produces a series of thematic files for a collection from 146 countries at administrative level 2. Each file captures different aspects of population, infrastructure, and environmental conditions. Below is an overview of the available files:</p>
<ol class="arabic simple">
<li><p><span class="xref myst"><strong>Access to Services</strong></span> – Population accessibility to key facilities such as education and health centers.</p></li>
<li><p><span class="xref myst"><strong>Facilities</strong></span> – Availability and distribution of essential service infrastructure.</p></li>
<li><p><span class="xref myst"><strong>Coping Capacity</strong></span> – Combined indicators derived from Access and Facilities layers.</p></li>
<li><p><span class="xref myst"><strong>Demographics</strong></span> – Distribution of vulnerable population.</p></li>
<li><p><span class="xref myst"><strong>Rural Population</strong></span> – Demographic indicators focused specifically on rural populations.</p></li>
<li><p><span class="xref myst"><strong>Vulnerability</strong></span> – Composite indicators derived from Demographics and Rural Population layers.</p></li>
<li><p><span class="xref myst"><strong>Crop Coverage and Change</strong></span> – Extent of agricultural land and observed changes over time.</p></li>
<li><p><span class="xref myst"><strong>Vegetation Index</strong></span> – NDVI-based assessment of vegetation conditions.</p></li>
<li><p><span class="xref myst"><strong>Flood Exposure</strong></span> – Exposure of populations and facilities to flood hazards.</p></li>
</ol>
<section id="available-countries">
<h3>Available Countries:<a class="headerlink" href="#available-countries" title="Permalink to this heading">#</a></h3>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Africa<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Country</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">1</p></td>
<td><p class="sd-card-text">AGO</p></td>
<td><p class="sd-card-text">Angola</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">2</p></td>
<td><p class="sd-card-text">BDI</p></td>
<td><p class="sd-card-text">Burundi</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">3</p></td>
<td><p class="sd-card-text">BEN</p></td>
<td><p class="sd-card-text">Benin</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">4</p></td>
<td><p class="sd-card-text">BFA</p></td>
<td><p class="sd-card-text">Burkina-Faso</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">5</p></td>
<td><p class="sd-card-text">BWA</p></td>
<td><p class="sd-card-text">Botswana</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">6</p></td>
<td><p class="sd-card-text">CAF</p></td>
<td><p class="sd-card-text">Central-African-Republic</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">7</p></td>
<td><p class="sd-card-text">CIV</p></td>
<td><p class="sd-card-text">Ivory-Coast</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">8</p></td>
<td><p class="sd-card-text">CMR</p></td>
<td><p class="sd-card-text">Cameroon</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">9</p></td>
<td><p class="sd-card-text">COD</p></td>
<td><p class="sd-card-text">Congo-Democratic-Republic</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">10</p></td>
<td><p class="sd-card-text">COG</p></td>
<td><p class="sd-card-text">Congo-Brazzaville</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">11</p></td>
<td><p class="sd-card-text">COM</p></td>
<td><p class="sd-card-text">Comores</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">12</p></td>
<td><p class="sd-card-text">CPV</p></td>
<td><p class="sd-card-text">Cape-Verde</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">13</p></td>
<td><p class="sd-card-text">DJI</p></td>
<td><p class="sd-card-text">Djibouti</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">14</p></td>
<td><p class="sd-card-text">DZA</p></td>
<td><p class="sd-card-text">Algeria</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">15</p></td>
<td><p class="sd-card-text">EGY</p></td>
<td><p class="sd-card-text">Egypt</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">16</p></td>
<td><p class="sd-card-text">ERI</p></td>
<td><p class="sd-card-text">Eritrea</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">17</p></td>
<td><p class="sd-card-text">ESH</p></td>
<td><p class="sd-card-text">Morocco</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">18</p></td>
<td><p class="sd-card-text">ETH</p></td>
<td><p class="sd-card-text">Ethiopia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">19</p></td>
<td><p class="sd-card-text">GAB</p></td>
<td><p class="sd-card-text">Gabon</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">20</p></td>
<td><p class="sd-card-text">GHA</p></td>
<td><p class="sd-card-text">Ghana</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">21</p></td>
<td><p class="sd-card-text">GIN</p></td>
<td><p class="sd-card-text">Guinea</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">22</p></td>
<td><p class="sd-card-text">GMB</p></td>
<td><p class="sd-card-text">Senegal-And-Gambia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">23</p></td>
<td><p class="sd-card-text">GNB</p></td>
<td><p class="sd-card-text">Guinea-Bissau</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">24</p></td>
<td><p class="sd-card-text">GNQ</p></td>
<td><p class="sd-card-text">Equatorial-Guinea</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">25</p></td>
<td><p class="sd-card-text">KEN</p></td>
<td><p class="sd-card-text">Kenya</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">26</p></td>
<td><p class="sd-card-text">LBR</p></td>
<td><p class="sd-card-text">Liberia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">27</p></td>
<td><p class="sd-card-text">LBY</p></td>
<td><p class="sd-card-text">Libya</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">28</p></td>
<td><p class="sd-card-text">LSO</p></td>
<td><p class="sd-card-text">Lesotho</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">29</p></td>
<td><p class="sd-card-text">MAR</p></td>
<td><p class="sd-card-text">Morocco</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">30</p></td>
<td><p class="sd-card-text">MDG</p></td>
<td><p class="sd-card-text">Madagascar</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">31</p></td>
<td><p class="sd-card-text">MLI</p></td>
<td><p class="sd-card-text">Mali</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">32</p></td>
<td><p class="sd-card-text">MOZ</p></td>
<td><p class="sd-card-text">Mozambique</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">33</p></td>
<td><p class="sd-card-text">MRT</p></td>
<td><p class="sd-card-text">Mauritania</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">34</p></td>
<td><p class="sd-card-text">MUS</p></td>
<td><p class="sd-card-text">Mauritius</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">35</p></td>
<td><p class="sd-card-text">MWI</p></td>
<td><p class="sd-card-text">Malawi</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">36</p></td>
<td><p class="sd-card-text">MYS</p></td>
<td><p class="sd-card-text">Malawi</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">37</p></td>
<td><p class="sd-card-text">NAM</p></td>
<td><p class="sd-card-text">Namibia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">38</p></td>
<td><p class="sd-card-text">NER</p></td>
<td><p class="sd-card-text">Niger</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">39</p></td>
<td><p class="sd-card-text">NGA</p></td>
<td><p class="sd-card-text">Nigeria</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">40</p></td>
<td><p class="sd-card-text">RWA</p></td>
<td><p class="sd-card-text">Rwanda</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">41</p></td>
<td><p class="sd-card-text">SDN</p></td>
<td><p class="sd-card-text">Sudan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">42</p></td>
<td><p class="sd-card-text">SEN</p></td>
<td><p class="sd-card-text">Senegal-And-Gambia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">43</p></td>
<td><p class="sd-card-text">SLE</p></td>
<td><p class="sd-card-text">Sierra-Leone</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">44</p></td>
<td><p class="sd-card-text">SOM</p></td>
<td><p class="sd-card-text">Somalia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">45</p></td>
<td><p class="sd-card-text">SSD</p></td>
<td><p class="sd-card-text">South-Sudan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">46</p></td>
<td><p class="sd-card-text">STP</p></td>
<td><p class="sd-card-text">Sao-Tome-And-Principe</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">47</p></td>
<td><p class="sd-card-text">SWZ</p></td>
<td><p class="sd-card-text">Eswatini</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">48</p></td>
<td><p class="sd-card-text">SYC</p></td>
<td><p class="sd-card-text">Seychelles</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">49</p></td>
<td><p class="sd-card-text">TCD</p></td>
<td><p class="sd-card-text">Chad</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">50</p></td>
<td><p class="sd-card-text">TGO</p></td>
<td><p class="sd-card-text">Togo</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">51</p></td>
<td><p class="sd-card-text">TUN</p></td>
<td><p class="sd-card-text">Tunisia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">52</p></td>
<td><p class="sd-card-text">TZA</p></td>
<td><p class="sd-card-text">Tanzania</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">53</p></td>
<td><p class="sd-card-text">UGA</p></td>
<td><p class="sd-card-text">Uganda</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">54</p></td>
<td><p class="sd-card-text">ZAF</p></td>
<td><p class="sd-card-text">South-Africa</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">55</p></td>
<td><p class="sd-card-text">ZMB</p></td>
<td><p class="sd-card-text">Zambia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">56</p></td>
<td><p class="sd-card-text">ZWE</p></td>
<td><p class="sd-card-text">Zimbabwe</p></td>
</tr>
</tbody>
</table>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Asia<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Country</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">57</p></td>
<td><p class="sd-card-text">AFG</p></td>
<td><p class="sd-card-text">Afghanistan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">58</p></td>
<td><p class="sd-card-text">ARE</p></td>
<td><p class="sd-card-text">Gcc-States</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">59</p></td>
<td><p class="sd-card-text">ARM</p></td>
<td><p class="sd-card-text">Armenia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">60</p></td>
<td><p class="sd-card-text">AZE</p></td>
<td><p class="sd-card-text">Azerbaijan</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">61</p></td>
<td><p class="sd-card-text">BGD</p></td>
<td><p class="sd-card-text">Bangladesh</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">62</p></td>
<td><p class="sd-card-text">BHR</p></td>
<td><p class="sd-card-text">Gcc-States</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">63</p></td>
<td><p class="sd-card-text">BTN</p></td>
<td><p class="sd-card-text">Bhutan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">64</p></td>
<td><p class="sd-card-text">CHN</p></td>
<td><p class="sd-card-text">China</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">65</p></td>
<td><p class="sd-card-text">IDN</p></td>
<td><p class="sd-card-text">Indonesia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">66</p></td>
<td><p class="sd-card-text">IRN</p></td>
<td><p class="sd-card-text">Iran</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">67</p></td>
<td><p class="sd-card-text">IRQ</p></td>
<td><p class="sd-card-text">Iraq</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">68</p></td>
<td><p class="sd-card-text">KAZ</p></td>
<td><p class="sd-card-text">Kazakhstan</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">69</p></td>
<td><p class="sd-card-text">KGZ</p></td>
<td><p class="sd-card-text">Kyrgyzstan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">70</p></td>
<td><p class="sd-card-text">KHM</p></td>
<td><p class="sd-card-text">Cambodia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">71</p></td>
<td><p class="sd-card-text">KWT</p></td>
<td><p class="sd-card-text">Gcc-States</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">72</p></td>
<td><p class="sd-card-text">LAO</p></td>
<td><p class="sd-card-text">Laos</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">73</p></td>
<td><p class="sd-card-text">LBN</p></td>
<td><p class="sd-card-text">Lebanon</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">74</p></td>
<td><p class="sd-card-text">LKA</p></td>
<td><p class="sd-card-text">Sri-Lanka</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">75</p></td>
<td><p class="sd-card-text">MDV</p></td>
<td><p class="sd-card-text">Maldives</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">76</p></td>
<td><p class="sd-card-text">MMR</p></td>
<td><p class="sd-card-text">Myanmar</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">77</p></td>
<td><p class="sd-card-text">MNG</p></td>
<td><p class="sd-card-text">Mongolia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">78</p></td>
<td><p class="sd-card-text">NPL</p></td>
<td><p class="sd-card-text">Nepal</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">79</p></td>
<td><p class="sd-card-text">OMN</p></td>
<td><p class="sd-card-text">Gcc-States</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">80</p></td>
<td><p class="sd-card-text">PAK</p></td>
<td><p class="sd-card-text">Pakistan</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">81</p></td>
<td><p class="sd-card-text">PHL</p></td>
<td><p class="sd-card-text">Philippines</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">82</p></td>
<td><p class="sd-card-text">PRK</p></td>
<td><p class="sd-card-text">North-Korea</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">83</p></td>
<td><p class="sd-card-text">QAT</p></td>
<td><p class="sd-card-text">Gcc-States</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">84</p></td>
<td><p class="sd-card-text">SAU</p></td>
<td><p class="sd-card-text">Gcc-States</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">85</p></td>
<td><p class="sd-card-text">SYR</p></td>
<td><p class="sd-card-text">Syria</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">86</p></td>
<td><p class="sd-card-text">THA</p></td>
<td><p class="sd-card-text">Thailand</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">87</p></td>
<td><p class="sd-card-text">TJK</p></td>
<td><p class="sd-card-text">Tajikistan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">88</p></td>
<td><p class="sd-card-text">TLS</p></td>
<td><p class="sd-card-text">Indonesia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">89</p></td>
<td><p class="sd-card-text">UZB</p></td>
<td><p class="sd-card-text">Uzbekistan</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">90</p></td>
<td><p class="sd-card-text">VNM</p></td>
<td><p class="sd-card-text">Vietnam</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">91</p></td>
<td><p class="sd-card-text">YEM</p></td>
<td><p class="sd-card-text">Yemen</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">92</p></td>
<td><p class="sd-card-text">PNG</p></td>
<td><p class="sd-card-text">Indonesia</p></td>
</tr>
</tbody>
</table>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Europe<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Country</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">93</p></td>
<td><p class="sd-card-text">ALB</p></td>
<td><p class="sd-card-text">Albania</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">94</p></td>
<td><p class="sd-card-text">BGR</p></td>
<td><p class="sd-card-text">Bulgaria</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">95</p></td>
<td><p class="sd-card-text">BLR</p></td>
<td><p class="sd-card-text">Belarus</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">96</p></td>
<td><p class="sd-card-text">GEO</p></td>
<td><p class="sd-card-text">Georgia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">97</p></td>
<td><p class="sd-card-text">GRC</p></td>
<td><p class="sd-card-text">Greece</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">98</p></td>
<td><p class="sd-card-text">HUN</p></td>
<td><p class="sd-card-text">Hungary</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">99</p></td>
<td><p class="sd-card-text">MDA</p></td>
<td><p class="sd-card-text">Moldova</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">100</p></td>
<td><p class="sd-card-text">MKD</p></td>
<td><p class="sd-card-text">Macedonia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">101</p></td>
<td><p class="sd-card-text">POL</p></td>
<td><p class="sd-card-text">Poland</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">102</p></td>
<td><p class="sd-card-text">ROU</p></td>
<td><p class="sd-card-text">Romania</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">103</p></td>
<td><p class="sd-card-text">SVK</p></td>
<td><p class="sd-card-text">Slovakia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">104</p></td>
<td><p class="sd-card-text">TUR</p></td>
<td><p class="sd-card-text">Turkey</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">105</p></td>
<td><p class="sd-card-text">UKR</p></td>
<td><p class="sd-card-text">Ukraine</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">106</p></td>
<td><p class="sd-card-text">RUS</p></td>
<td><p class="sd-card-text">Russia</p></td>
</tr>
</tbody>
</table>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
South America<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Country</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">107</p></td>
<td><p class="sd-card-text">ARG</p></td>
<td><p class="sd-card-text">Argentina</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">108</p></td>
<td><p class="sd-card-text">BOL</p></td>
<td><p class="sd-card-text">Bolivia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">109</p></td>
<td><p class="sd-card-text">BRA</p></td>
<td><p class="sd-card-text">Brazil</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">110</p></td>
<td><p class="sd-card-text">CHL</p></td>
<td><p class="sd-card-text">Chile</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">111</p></td>
<td><p class="sd-card-text">COL</p></td>
<td><p class="sd-card-text">Colombia</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">112</p></td>
<td><p class="sd-card-text">ECU</p></td>
<td><p class="sd-card-text">Ecuador</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">113</p></td>
<td><p class="sd-card-text">GUY</p></td>
<td><p class="sd-card-text">Guyana</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">114</p></td>
<td><p class="sd-card-text">PER</p></td>
<td><p class="sd-card-text">Peru</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">115</p></td>
<td><p class="sd-card-text">PRY</p></td>
<td><p class="sd-card-text">Paraguay</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">116</p></td>
<td><p class="sd-card-text">SUR</p></td>
<td><p class="sd-card-text">Suriname</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">117</p></td>
<td><p class="sd-card-text">URY</p></td>
<td><p class="sd-card-text">Uruguay</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">118</p></td>
<td><p class="sd-card-text">VEN</p></td>
<td><p class="sd-card-text">Venezuela</p></td>
</tr>
</tbody>
</table>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Central America &amp; Caribbean<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Country</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">119</p></td>
<td><p class="sd-card-text">ATG</p></td>
<td><p class="sd-card-text">Antigua and Barbuda</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">120</p></td>
<td><p class="sd-card-text">BHS</p></td>
<td><p class="sd-card-text">Bahamas</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">121</p></td>
<td><p class="sd-card-text">BLZ</p></td>
<td><p class="sd-card-text">Belize</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">122</p></td>
<td><p class="sd-card-text">CRI</p></td>
<td><p class="sd-card-text">Costa-Rica</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">123</p></td>
<td><p class="sd-card-text">CUB</p></td>
<td><p class="sd-card-text">Cuba</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">124</p></td>
<td><p class="sd-card-text">DMA</p></td>
<td><p class="sd-card-text">Dominica</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">125</p></td>
<td><p class="sd-card-text">DOM</p></td>
<td><p class="sd-card-text">Haiti-And-DomRep</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">126</p></td>
<td><p class="sd-card-text">GTM</p></td>
<td><p class="sd-card-text">Guatemala</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">127</p></td>
<td><p class="sd-card-text">HND</p></td>
<td><p class="sd-card-text">Honduras</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">128</p></td>
<td><p class="sd-card-text">HTI</p></td>
<td><p class="sd-card-text">Haiti-And-DomRep</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">129</p></td>
<td><p class="sd-card-text">JAM</p></td>
<td><p class="sd-card-text">Jamaica</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">130</p></td>
<td><p class="sd-card-text">NIC</p></td>
<td><p class="sd-card-text">Nicaragua</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">131</p></td>
<td><p class="sd-card-text">PAN</p></td>
<td><p class="sd-card-text">Panama</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">132</p></td>
<td><p class="sd-card-text">SLV</p></td>
<td><p class="sd-card-text">El-Salvador</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">133</p></td>
<td><p class="sd-card-text">TTO</p></td>
<td><p class="sd-card-text">None</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">134</p></td>
<td><p class="sd-card-text">VCT</p></td>
<td><p class="sd-card-text">None</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">135</p></td>
<td><p class="sd-card-text">BRB</p></td>
<td><p class="sd-card-text">Central-America</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">136</p></td>
<td><p class="sd-card-text">LCA</p></td>
<td><p class="sd-card-text">None</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">137</p></td>
<td><p class="sd-card-text">KNA</p></td>
<td><p class="sd-card-text">None</p></td>
</tr>
</tbody>
</table>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Australia &amp; Oceania<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Slug</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">138</p></td>
<td><p class="sd-card-text">FJI</p></td>
<td><p class="sd-card-text">Fiji</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">139</p></td>
<td><p class="sd-card-text">FSM</p></td>
<td><p class="sd-card-text">Micronesia</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">140</p></td>
<td><p class="sd-card-text">KIR</p></td>
<td><p class="sd-card-text">Kiribati</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">141</p></td>
<td><p class="sd-card-text">MHL</p></td>
<td><p class="sd-card-text">Marshall-Islands</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">142</p></td>
<td><p class="sd-card-text">SLB</p></td>
<td><p class="sd-card-text">Solomon-Islands</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">143</p></td>
<td><p class="sd-card-text">TON</p></td>
<td><p class="sd-card-text">Tonga</p></td>
</tr>
<tr class="row-even"><td><p class="sd-card-text">144</p></td>
<td><p class="sd-card-text">VUT</p></td>
<td><p class="sd-card-text">Vanuatu</p></td>
</tr>
</tbody>
</table>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
North America<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p class="sd-card-text">ID</p></th>
<th class="head"><p class="sd-card-text">Country Code</p></th>
<th class="head"><p class="sd-card-text">Country</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p class="sd-card-text">145</p></td>
<td><p class="sd-card-text">GRD</p></td>
<td><p class="sd-card-text">Greenland</p></td>
</tr>
<tr class="row-odd"><td><p class="sd-card-text">146</p></td>
<td><p class="sd-card-text">MEX</p></td>
<td><p class="sd-card-text">Mexico</p></td>
</tr>
</tbody>
</table>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="risk-assessment-plugin">
<h2>Risk Assessment Plugin<a class="headerlink" href="#risk-assessment-plugin" title="Permalink to this heading">#</a></h2>
<p>The datasets produced by GAIA are fully compatible with the <a class="reference external" href="https://giscience.github.io/gis-training-resource-center/content/GIS_AA/en_qgis_risk_assessment_plugin.html">Risk Assessment QGIS Plugin</a>, enabling seamless integration into spatial risk analyses. They are openly available for multiple countries through <a class="reference external" href="https://data.humdata.org/organization/heidelberg-institute-for-geoinformation-technology?sort=metadata_modified+desc">HeiGIT on HDX</a>, providing ready-to-use geospatial layers for risk assessments.</p>
<div class="tip admonition">
<p class="admonition-title">Information</p>
<p>The <strong>Coping Capacity</strong>, <strong>Vulnerability</strong>, and <strong>Flood Exposure</strong> files can be used directly as input for the Risk Assessment QGIS Plugin when analyzing flood hazards. Only minor adjustments, such as renaming the ID columns, are required for compatibility.</p>
</div>
</section>
<hr class="docutils" />
<section id="access-to-services">
<h2>1. Access to Services<a class="headerlink" href="#access-to-services" title="Permalink to this heading">#</a></h2>
<p>Represents the share of the population with access to key facilities within defined distances or travel times.</p>
<section id="data-sources">
<h3>Data Sources<a class="headerlink" href="#data-sources" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Accessibility data (isochrones) downloaded from <strong>MinIO</strong> for the categories: <code class="docutils literal notranslate"><span class="pre">education</span></code>, <code class="docutils literal notranslate"><span class="pre">hospitals</span></code>, <code class="docutils literal notranslate"><span class="pre">primary_healthcare</span></code>.</p></li>
<li><p>Population data: WorldPop raster data (vulnerable populations) via <em>Demographics</em>.</p></li>
</ul>
</section>
<section id="processing-steps">
<h3>Processing Steps<a class="headerlink" href="#processing-steps" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Download accessibility isochrones</strong> in GPKG format for each category.</p></li>
<li><p><strong>Load administrative boundaries</strong> at admin level 2 from local GeoJSON files.</p></li>
<li><p><strong>Fetch WorldPop raster datasets</strong> and sum relevant indicators to produce a vulnerable population raster.</p></li>
<li><p>For each category and cutoff:</p>
<ul class="simple">
<li><p>Select isochrone polygons for the cutoff value.</p></li>
<li><p>Intersect polygons with administrative boundaries.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">rasterstats.zonal_stats</span></code> to compute total population within the isochrone area.</p></li>
</ul>
</li>
<li><p>Save results as a CSV containing population counts per administrative unit.</p></li>
</ol>
</section>
<section id="outputs">
<h3>Outputs<a class="headerlink" href="#outputs" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>CSV file: <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_access.csv</span></code></p>
<ul>
<li><p>Columns: <code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code>, <code class="docutils literal notranslate"><span class="pre">access_pop_education_5km</span></code>, <code class="docutils literal notranslate"><span class="pre">access_pop_education_10km</span></code>, etc.</p></li>
<li><p>CRS: WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p>Units: population count</p></li>
</ul>
</li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Access to Services)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rioxarray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zonal_stats</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scripts.fetch_worldpop</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_worldpop</span>


<span class="n">CATEGORY_SPECS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;education&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ranges&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">5000</span><span class="p">:</span> <span class="s2">&quot;access_pop_education_5km&quot;</span><span class="p">,</span>
                   <span class="mi">10000</span><span class="p">:</span> <span class="s2">&quot;access_pop_education_10km&quot;</span><span class="p">,</span>
                   <span class="mi">20000</span><span class="p">:</span> <span class="s2">&quot;access_pop_education_20km&quot;</span><span class="p">},</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span>  <span class="c1"># meters</span>
    <span class="p">},</span>
    <span class="s2">&quot;hospitals&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ranges&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1800</span><span class="p">:</span> <span class="s2">&quot;access_pop_hospitals_30min&quot;</span><span class="p">,</span>
                   <span class="mi">3600</span><span class="p">:</span> <span class="s2">&quot;access_pop_hospitals_1h&quot;</span><span class="p">,</span>
                   <span class="mi">7200</span><span class="p">:</span> <span class="s2">&quot;access_pop_hospitals_2h&quot;</span><span class="p">},</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>  <span class="c1"># seconds</span>
    <span class="p">},</span>
    <span class="s2">&quot;primary_healthcare&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;ranges&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1800</span><span class="p">:</span> <span class="s2">&quot;access_pop_primary_healthcare_30min&quot;</span><span class="p">,</span>
                   <span class="mi">3600</span><span class="p">:</span> <span class="s2">&quot;access_pop_primary_healthcare_1h&quot;</span><span class="p">,</span>
                   <span class="mi">7200</span><span class="p">:</span> <span class="s2">&quot;access_pop_primary_healthcare_2h&quot;</span><span class="p">},</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>  <span class="c1"># seconds</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_access_gpkg</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download accessibility gpkg file if missing, return path.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://warm.storage.heigit.org/heigit-hdx-public/access/</span><span class="si">{</span><span class="n">country_code</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_access.gpkg&quot;</span>
    <span class="n">gpkg_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_access.gpkg&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">gpkg_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> access GPKG…&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gpkg_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gpkg_path</span><span class="si">}</span><span class="s2"> already exists, skipping download.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gpkg_path</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_value_field</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try to find the field that contains the isochrone cutoff values.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span>
    <span class="c1"># fallback: first numeric column</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Guessed value field: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">col</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not identify value/range column in isochrones&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_access_population</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">,</span> <span class="n">gdf_admin</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute how much vulnerable population lives within accessibility isochrones,</span>
<span class="sd">    grouped by chosen administrative level.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">country_code</span> <span class="o">=</span> <span class="n">country_code</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">work_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">out_csv</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_access.csv&quot;</span>

    <span class="k">if</span> <span class="n">out_csv</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV already exists, skipping: </span><span class="si">{</span><span class="n">out_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_csv</span><span class="p">)</span>

    <span class="c1"># --- ensure vulnerable population raster ---</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching WorldPop rasters…&quot;</span><span class="p">)</span>
    <span class="n">indicator_tifs</span> <span class="o">=</span> <span class="n">fetch_worldpop</span><span class="p">(</span><span class="n">country_code</span><span class="p">)</span>
    <span class="n">pop_rasters</span> <span class="o">=</span> <span class="p">[</span><span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">indicator_tifs</span><span class="p">]</span>

    <span class="n">vuln_pop</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pop_rasters</span><span class="p">)</span>
    <span class="n">vuln_tmp</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_vulnerable_pop.tif&quot;</span>
    <span class="n">vuln_pop</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">vuln_tmp</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">:</span> <span class="n">gdf_admin</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]})</span>

    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">CATEGORY_SPECS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">gpkg_path</span> <span class="o">=</span> <span class="n">download_access_gpkg</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="c1"># Load ADM0 isochrones</span>
        <span class="n">isochrones</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">gpkg_path</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;ADM0&quot;</span><span class="p">)</span>
        <span class="n">isochrones</span> <span class="o">=</span> <span class="n">isochrones</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>

        <span class="n">value_field</span> <span class="o">=</span> <span class="n">find_value_field</span><span class="p">(</span><span class="n">isochrones</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;ranges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: processing </span><span class="si">{</span><span class="n">cutoff</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="n">subset</span> <span class="o">=</span> <span class="n">isochrones</span><span class="p">[</span><span class="n">isochrones</span><span class="p">[</span><span class="n">value_field</span><span class="p">]</span> <span class="o">==</span> <span class="n">cutoff</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Skip creating this column if no polygons found</span>
                <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No polygons found for </span><span class="si">{</span><span class="n">cutoff</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> — skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span> 

            <span class="c1"># Intersect chosen admin level with isochrone</span>
            <span class="n">admin_in_range</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">gdf_admin</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;intersection&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">admin_in_range</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No intersections found for </span><span class="si">{</span><span class="n">cutoff</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> — skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span> 

            <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">admin_in_range</span><span class="p">,</span> <span class="n">vuln_tmp</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">geojson_out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No zonal stats computed for </span><span class="si">{</span><span class="n">cutoff</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> — skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>  

            <span class="n">sums</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
                <span class="n">pcode</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]</span>
                <span class="n">sums</span><span class="p">[</span><span class="n">pcode</span><span class="p">]</span> <span class="o">=</span> <span class="n">sums</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pcode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">results</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sums</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accessibility population CSV written to </span><span class="si">{</span><span class="n">out_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="facilities">
<h2>2. Facilities<a class="headerlink" href="#facilities" title="Permalink to this heading">#</a></h2>
<p>Represents the availability and spatial distribution of essential service infrastructure such as schools, hospitals, and primary healthcare centers.</p>
<section id="id1">
<h3>Data Sources<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>OpenStreetMap (OSM)</strong> data, accessed through either:</p>
<ul>
<li><p><strong>Overpass API</strong>, for direct querying of recent OSM feature data; or</p></li>
<li><p><strong>Ohsome API</strong>, for more stable and filtered access to OSM geometries.</p></li>
</ul>
</li>
<li><p><strong>Administrative boundaries</strong> (GeoJSON): Used to spatially aggregate features at administrative level 2.</p></li>
</ul>
</section>
<section id="id2">
<h3>Processing Steps<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Load administrative boundaries</strong> (GeoJSON) for the target country at the desired administrative level.</p></li>
<li><p><strong>Define filters</strong> for each facility type:</p>
<ul class="simple">
<li><p><strong>Education:</strong> <code class="docutils literal notranslate"><span class="pre">amenity=school</span></code></p></li>
<li><p><strong>Hospitals:</strong> <code class="docutils literal notranslate"><span class="pre">amenity=hospital</span></code> or <code class="docutils literal notranslate"><span class="pre">healthcare=hospital</span></code></p></li>
<li><p><strong>Primary healthcare:</strong> Non-hospital facilities providing healthcare services, such as <code class="docutils literal notranslate"><span class="pre">clinic</span></code>, <code class="docutils literal notranslate"><span class="pre">doctors</span></code>, <code class="docutils literal notranslate"><span class="pre">midwife</span></code>, <code class="docutils literal notranslate"><span class="pre">nurse</span></code>, or <code class="docutils literal notranslate"><span class="pre">center</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Determine API source:</strong></p>
<ul class="simple">
<li><p>If Overpass is used, queries are dynamically built and executed using bounding boxes of the country boundary.</p></li>
<li><p>If Ohsome is used, geometry data is fetched for the same bounding box and time period (if specified).</p></li>
</ul>
</li>
<li><p><strong>Download and parse facility points</strong>:</p>
<ul class="simple">
<li><p>For Overpass: CSV results are parsed into GeoDataFrames with <code class="docutils literal notranslate"><span class="pre">lon</span></code>, <code class="docutils literal notranslate"><span class="pre">lat</span></code>, and <code class="docutils literal notranslate"><span class="pre">osmId</span></code> attributes.</p></li>
<li><p>For Ohsome: JSON features are directly converted into GeoDataFrames.</p></li>
</ul>
</li>
<li><p><strong>Assign categories and export raw results</strong>:</p>
<ul class="simple">
<li><p>Each facility type (education, hospitals, primary healthcare) is stored as a separate GeoJSON in a <code class="docutils literal notranslate"><span class="pre">Temporary</span></code> folder.</p></li>
</ul>
</li>
<li><p><strong>Aggregate by administrative unit</strong>:</p>
<ul class="simple">
<li><p>Facilities are spatially joined (<code class="docutils literal notranslate"><span class="pre">sjoin</span></code>) with administrative polygons.</p></li>
<li><p>For each category, counts are grouped by <code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Combine and export results</strong>:</p>
<ul class="simple">
<li><p>Counts for all categories are merged into a single summary table.</p></li>
<li><p>Output is saved as a CSV file in the <code class="docutils literal notranslate"><span class="pre">Output</span></code> directory.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id3">
<h3>Outputs<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>CSV file: <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_facilities.csv</span></code></p>
<ul>
<li><p>Columns:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">education_count</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hospitals_count</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">primary_healthcare_count</span></code></p></li>
</ul>
</li>
<li><p>CRS: WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p>Units: number of facilities per administrative unit</p></li>
</ul>
</li>
<li><p>Intermediate GeoJSON files:</p>
<ul>
<li><p>Stored in <code class="docutils literal notranslate"><span class="pre">Temporary/</span></code> folder as raw point data for each facility category.</p></li>
</ul>
</li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Facilities)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">overpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OGR_GEOJSON_MAX_OBJ_SIZE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="c1"># no limits when reading complex geojsons</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

<span class="n">OVERPASS_FILTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;education&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;nwr[amenity=school]&quot;</span><span class="p">],</span>
    <span class="s2">&quot;hospitals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;nwr[amenity=hospital]&quot;</span><span class="p">,</span><span class="s2">&quot;nwr[healthcare=hospital]&quot;</span><span class="p">],</span>
    
    <span class="s2">&quot;primary_healthcare&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;nwr[&quot;amenity&quot;~&quot;^(doctors|clinic)$&quot;][&quot;amenity&quot;!=&quot;hospital&quot;][&quot;healthcare&quot;!=&quot;hospital&quot;]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nwr[&quot;healthcare&quot;~&quot;^(clinic|doctors|midwife|nurse|center)$&quot;][&quot;amenity&quot; != &quot;hospital&quot;][&quot;healthcare&quot; != &quot;hospital&quot;]&#39;</span>
    <span class="p">]</span> 
<span class="p">}</span>

<span class="n">OHSOME_ENDPOINT</span> <span class="o">=</span> <span class="s2">&quot;https://api.ohsome.org/v1/elements/geometry&quot;</span>

<span class="n">OHSOME_FILTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;education&quot;</span><span class="p">:</span> <span class="s2">&quot;amenity=school&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hospitals&quot;</span><span class="p">:</span> <span class="s2">&quot;amenity=hospital or healthcare=hospital&quot;</span><span class="p">,</span>
    <span class="s2">&quot;primary_healthcare&quot;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s2">&quot;not amenity=hospital and not healthcare=hospital and &quot;</span>
        <span class="s2">&quot;(amenity=doctors or amenity=clinic or healthcare=clinic or &quot;</span>
        <span class="s2">&quot;healthcare=doctors or healthcare=midwife or healthcare=nurse or healthcare=center)&quot;</span>
    <span class="p">),</span>
<span class="p">}</span>



<span class="k">def</span><span class="w"> </span><span class="nf">parse_overpass_csv_to_gpd</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;@lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;@lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;@lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;@lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;@lon&#39;</span><span class="p">:</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;@lat&#39;</span><span class="p">:</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;osmId&#39;</span><span class="p">})</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]),</span>
        <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gdf</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fetch_overpass</span><span class="p">(</span><span class="n">context_log</span><span class="p">,</span> <span class="n">boundary_file</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using Overpass API to fetch facilities...&quot;</span><span class="p">)</span>
    <span class="n">id_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_PCODE&quot;</span>

    <span class="c1"># Paths for output files</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;Temporary&quot;</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;Output&quot;</span>
    <span class="n">expected_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_facilities.csv&quot;</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_raw.geojson&quot;</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">OVERPASS_FILTERS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="c1"># Check if all expected files exist → skip</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">expected_files</span><span class="p">):</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Overpass output files exist. Skipping fetch_overpass.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expected_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return main summary path</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">boundary_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading boundary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">id_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">boundary</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected ID column </span><span class="si">{</span><span class="n">id_col</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">boundary_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">boundary</span><span class="o">.</span><span class="n">total_bounds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">bbox_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">date_clause</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[date:&quot;</span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s1">&quot;]&#39;</span> <span class="k">if</span> <span class="n">time</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">api</span> <span class="o">=</span> <span class="n">overpass</span><span class="o">.</span><span class="n">API</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">category_gdfs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">exprs</span> <span class="ow">in</span> <span class="n">OVERPASS_FILTERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">filter_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">bbox_str</span><span class="si">}</span><span class="s2">);&quot;</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[out:csv(::lon,::lat,::id,::type)]</span><span class="si">{</span><span class="n">date_clause</span><span class="si">}</span><span class="s1">;(</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_parts</span><span class="p">)</span><span class="si">}</span><span class="s1">);out center;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">build</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overpass query failed for </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No results for </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">parse_overpass_csv_to_gpd</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No features found for </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>
        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>

        <span class="n">raw_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_raw.geojson&quot;</span>
        <span class="n">raw_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote raw </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> features to </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">category_gdfs</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">category_gdfs</span><span class="p">:</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Overpass features found at all.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">[[</span><span class="n">id_col</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="n">category_gdfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">id_col</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">id_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">id_col</span><span class="p">})</span>

    <span class="n">summary_path</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_facilities.csv&quot;</span>
    <span class="n">summary_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">counts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">summary_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote summary to </span><span class="si">{</span><span class="n">summary_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">summary_path</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_ohsome</span><span class="p">(</span><span class="n">context_log</span><span class="p">,</span> <span class="n">boundary_file</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using Ohsome API to fetch facilities...&quot;</span><span class="p">)</span>

    <span class="n">id_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_PCODE&quot;</span>

    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;Temporary&quot;</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="s2">&quot;Output&quot;</span>
    <span class="n">expected_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_facilities.csv&quot;</span>
    <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_raw.geojson&quot;</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">OHSOME_FILTERS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">expected_files</span><span class="p">):</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All Ohsome output files exist. Skipping fetch_ohsome.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expected_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">boundary_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading boundary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">id_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">boundary</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected ID column </span><span class="si">{</span><span class="n">id_col</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">boundary_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">boundary</span><span class="o">.</span><span class="n">total_bounds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">bbox_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">minx</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">miny</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">maxx</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">maxy</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">category_gdfs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">filter_str</span> <span class="ow">in</span> <span class="n">OHSOME_FILTERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bboxes&quot;</span><span class="p">:</span> <span class="n">bbox_str</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">filter_str</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">time</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">OHSOME_ENDPOINT</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ohsome query failed for </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No features found for </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>
        <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category</span>

        <span class="n">raw_path</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_raw.geojson&quot;</span>
        <span class="n">raw_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">raw_path</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote raw </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> features to </span><span class="si">{</span><span class="n">raw_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">category_gdfs</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">category_gdfs</span><span class="p">:</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No categories found, nothing to aggregate.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">boundary</span><span class="p">[[</span><span class="n">id_col</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="n">category_gdfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;intersects&quot;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">id_col</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">id_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">id_col</span><span class="p">})</span>

    <span class="n">summary_path</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_facilities.csv&quot;</span>
    <span class="n">summary_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">counts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">summary_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote summary to </span><span class="si">{</span><span class="n">summary_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">summary_path</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="coping-capacity">
<h2>3. Coping Capacity<a class="headerlink" href="#coping-capacity" title="Permalink to this heading">#</a></h2>
<p>Represents the ability of a population to access essential services and benefit from available infrastructure.<br />
This layer combines <em>Access to Services</em> and <em>Facilities</em> indicators to assess local capacity to cope with shocks or disruptions.</p>
<section id="id4">
<h3>Data Sources<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Access to Services CSVs:</strong> Derived from population accessibility analysis (see <em>Access to Services</em> chapter).</p></li>
<li><p><strong>Facilities CSVs:</strong> Derived from OpenStreetMap facility data (see <em>Facilities</em> chapter).</p></li>
<li><p>Both inputs are aggregated at the same administrative level (e.g., ADM2).</p></li>
</ul>
</section>
<section id="id5">
<h3>Processing Steps<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Input CSVs:</strong></p>
<ul class="simple">
<li><p>One <em>Access to Services</em> CSV and one <em>Facilities</em> CSV are provided per administrative level.</p></li>
<li><p>Each CSV includes an identifier column such as <code class="docutils literal notranslate"><span class="pre">ADM0_PCODE</span></code>, <code class="docutils literal notranslate"><span class="pre">ADM1_PCODE</span></code>, or <code class="docutils literal notranslate"><span class="pre">ADM2_PCODE</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Column Detection:</strong></p>
<ul class="simple">
<li><p>The script automatically detects the administrative identifier column by searching for any column ending with <code class="docutils literal notranslate"><span class="pre">_PCODE</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Merge Operation:</strong></p>
<ul class="simple">
<li><p>The two datasets are merged on the identified <code class="docutils literal notranslate"><span class="pre">*_PCODE</span></code> column using a left join.</p></li>
<li><p>This ensures all access indicators are retained even if some administrative areas lack facility data.</p></li>
</ul>
</li>
<li><p><strong>Output Generation:</strong></p>
<ul class="simple">
<li><p>The merged dataset is saved as <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_coping.csv</span></code> under <code class="docutils literal notranslate"><span class="pre">Output/</span></code>.</p></li>
<li><p>One output is produced per administrative level present in the input data.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id6">
<h3>Outputs<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>CSV file: <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_coping.csv</span></code></p>
<ul>
<li><p>Columns:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p>All accessibility indicator columns (e.g., <code class="docutils literal notranslate"><span class="pre">access_pop_education_5km</span></code>, <code class="docutils literal notranslate"><span class="pre">access_pop_hospitals_1h</span></code>)</p></li>
<li><p>All facility count columns (e.g., <code class="docutils literal notranslate"><span class="pre">education_count</span></code>, <code class="docutils literal notranslate"><span class="pre">hospitals_count</span></code>, <code class="docutils literal notranslate"><span class="pre">primary_healthcare_count</span></code>)</p></li>
</ul>
</li>
<li><p>CRS: WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p>Units: counts and population values aggregated per administrative unit</p></li>
</ul>
</li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Coping Capacity)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="k">def</span><span class="w"> </span><span class="nf">coping_asset</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">access_asset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">facilities_asset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine accessibility and facilities CSVs into a single coping dataset.</span>
<span class="sd">    Joins on the ADM*_PCODE column per admin level.</span>
<span class="sd">    Produces one coping CSV per admin level in Output/.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_code</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">partition_key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">access_csv</span><span class="p">,</span> <span class="n">facilities_csv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">access_asset</span><span class="p">,</span> <span class="n">facilities_asset</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">access_csv</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">facilities_csv</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping merge for </span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">: missing files </span><span class="si">{</span><span class="n">access_csv</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">facilities_csv</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_access</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">access_csv</span><span class="p">)</span>
            <span class="n">df_facilities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">facilities_csv</span><span class="p">)</span>

            <span class="c1"># detect admin code column automatically (ADM0_PCODE, ADM1_PCODE, etc.)</span>
            <span class="n">id_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_access</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_PCODE&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">id_col</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">access_csv</span><span class="si">}</span><span class="s2">: no *_PCODE column found&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">id_col</span> <span class="o">=</span> <span class="n">id_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_access</span><span class="p">,</span> <span class="n">df_facilities</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">id_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

            <span class="n">admin_level</span> <span class="o">=</span> <span class="n">id_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># e.g., ADM2</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">country_code</span> <span class="o">/</span> <span class="s2">&quot;Output&quot;</span>
            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_coping.csv&quot;</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>

            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">] Wrote coping CSV: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to merge </span><span class="si">{</span><span class="n">access_csv</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">facilities_csv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No coping outputs created for </span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="demographics">
<h2>4. Demographics<a class="headerlink" href="#demographics" title="Permalink to this heading">#</a></h2>
<p>Provides population distribution indicators based on <strong>age</strong> and <strong>sex</strong>.<br />
This layer is derived from the <a class="reference external" href="https://www.worldpop.org/"><strong>WorldPop</strong></a> global population dataset and quantifies vulnerable population groups across administrative boundaries.</p>
<section id="id7">
<h3>Data Sources<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>WorldPop Age-Sex Population Rasters:</strong><br />
Downloaded from the <a class="reference external" href="https://www.worldpop.org/geodata/listing?id=77">WorldPop Global Constrained Population dataset</a> (<code class="docutils literal notranslate"><span class="pre">Global_2000_2020_Constrained</span></code>).</p></li>
<li><p><strong>Administrative boundaries</strong> (GeoJSON): Used to spatially aggregate features at administrative level 2.</p></li>
</ul>
</section>
<section id="indicators">
<h3>Indicators<a class="headerlink" href="#indicators" title="Permalink to this heading">#</a></h3>
<p>Each demographic indicator represents the <strong>sum of population counts</strong> matching specified age and sex ranges:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Indicator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Ages (years)</p></th>
<th class="head"><p>Sexes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">female_pop</span></code></p></td>
<td><p>Total female population</p></td>
<td><p>0–80+</p></td>
<td><p>f</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">children_u5</span></code></p></td>
<td><p>Total children under 5</p></td>
<td><p>0–4</p></td>
<td><p>f, m</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">female_u5</span></code></p></td>
<td><p>Female children under 5</p></td>
<td><p>0–4</p></td>
<td><p>f</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">elderly</span></code></p></td>
<td><p>Population aged 65 and above</p></td>
<td><p>65+</p></td>
<td><p>f, m</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pop_u15</span></code></p></td>
<td><p>Population under 15</p></td>
<td><p>0–14</p></td>
<td><p>f, m</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">female_u15</span></code></p></td>
<td><p>Female population under 15</p></td>
<td><p>0–14</p></td>
<td><p>f</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id8">
<h3>Processing Steps<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Download Required WorldPop Tiles</strong></p>
<ul class="simple">
<li><p>For each indicator, the script identifies which age/sex rasters are needed (e.g., <code class="docutils literal notranslate"><span class="pre">m_0</span></code>, <code class="docutils literal notranslate"><span class="pre">f_1</span></code>, etc.).</p></li>
<li><p>Tiles are downloaded from <strong>Worldpop</strong>.</p></li>
</ul>
</li>
<li><p><strong>Merge and Sum Rasters</strong></p>
<ul class="simple">
<li><p>The corresponding age/sex tiles are summed into one raster per indicator.</p></li>
<li><p>Outputs are saved in <code class="docutils literal notranslate"><span class="pre">data/{country}/Temporary/</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Aggregate by Administrative Units</strong></p>
<ul class="simple">
<li><p>Using the administrative boundary GeoJSON (e.g., <code class="docutils literal notranslate"><span class="pre">ADM2</span></code>), zonal statistics are computed for each indicator.</p></li>
<li><p>Population counts are summed per administrative area.</p></li>
</ul>
</li>
<li><p><strong>Output</strong></p>
<ul class="simple">
<li><p>A single CSV per country: <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_demographics.csv</span></code></p></li>
<li><p>Saved to <code class="docutils literal notranslate"><span class="pre">data/{country}/Output/</span></code></p></li>
</ul>
</li>
</ol>
</section>
<section id="id9">
<h3>Outputs<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_demographics.csv</span></code></p></li>
<li><p><strong>Columns:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">female_pop</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">children_u5</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">female_u5</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">elderly</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pop_u15</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">female_u15</span></code></p></li>
</ul>
</li>
<li><p><strong>CRS:</strong> WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p><strong>Units:</strong> Population counts (integer, aggregated per administrative unit)</p></li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Demographics)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zonal_stats</span>

<span class="c1"># Define indicators directly</span>
<span class="n">INDICATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;female_pop&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="s2">&quot;sexes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;children_u5&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;sexes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;female_u5&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;sexes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;elderly&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">65</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="s2">&quot;sexes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;pop_u15&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="s2">&quot;sexes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]},</span>
    <span class="s2">&quot;female_u15&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="s2">&quot;sexes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">]},</span>
<span class="p">}</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://data.worldpop.org/GIS&quot;</span>
<span class="n">POP_TIMEFRAME</span> <span class="o">=</span> <span class="s2">&quot;Global_2000_2020_Constrained&quot;</span>
<span class="n">YEAR</span> <span class="o">=</span> <span class="s2">&quot;2020&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">):</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">merge_and_sum_rasters</span><span class="p">(</span><span class="n">raster_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context_log</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open each path in `raster_paths`, read band 1 into memory, sum them,</span>
<span class="sd">    and write a single‐band float32 GeoTIFF to `out_path`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raster_paths</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No rasters passed for merging!&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raster_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">src0</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">src0</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_sum</span> <span class="o">=</span> <span class="n">src0</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">raster_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
            <span class="n">data_sum</span> <span class="o">+=</span> <span class="n">arr</span>

    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data_sum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote merged raster to </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fetch_worldpop</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">context_log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">worldpop_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download WorldPop rasters for a country and aggregate into indicator rasters.</span>
<span class="sd">    Produces 6 GeoTIFFs: one per indicator (no total population).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context_log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">context_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;worldpop&quot;</span><span class="p">)</span>

    <span class="n">country</span> <span class="o">=</span> <span class="n">country</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">worldpop_code</span><span class="p">:</span>
        <span class="n">worldpop_code</span> <span class="o">=</span> <span class="n">country</span>
        <span class="n">worldpop_code_low</span> <span class="o">=</span> <span class="n">country</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">worldpop_code_low</span> <span class="o">=</span> <span class="n">worldpop_code</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Force output directory to Temporary</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="s2">&quot;Temporary&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Pre-check: if all 6 indicator rasters already exist, skip</span>
    <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_pop_</span><span class="si">{</span><span class="n">ind_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">YEAR</span><span class="si">}</span><span class="s2">_constrained.tif&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind_name</span> <span class="ow">in</span> <span class="n">INDICATORS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">expected_outputs</span><span class="p">):</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">] → all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expected_outputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> WorldPop indicators already exist, skipping download.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expected_outputs</span>
    
    <span class="n">out_dir_raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;worldpop_raw&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir_raw</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">downloaded</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># 1) Download needed age/sex rasters</span>
    <span class="n">needed_bins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">INDICATORS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="s2">&quot;sexes&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ages&quot;</span><span class="p">]:</span>
                <span class="n">needed_bins</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">sex</span><span class="p">,</span> <span class="n">age</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">sex</span><span class="p">,</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">needed_bins</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">worldpop_code_low</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sex</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">YEAR</span><span class="si">}</span><span class="s2">_constrained.tif&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/AgeSex_structures/</span><span class="si">{</span><span class="n">POP_TIMEFRAME</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">YEAR</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">worldpop_code</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir_raw</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sex</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">YEAR</span><span class="si">}</span><span class="s2">_constrained.tif&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">] → downloading </span><span class="si">{</span><span class="n">sex</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">download_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] failed to download </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">] → skipping existing </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">downloaded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

    <span class="c1"># 2) Aggregate indicators</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind_name</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">INDICATORS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">filtered_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir_raw</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sex</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">YEAR</span><span class="si">}</span><span class="s2">_constrained.tif&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sex</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="s2">&quot;sexes&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">age</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">[</span><span class="s2">&quot;ages&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">merged_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">_pop_</span><span class="si">{</span><span class="n">ind_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">YEAR</span><span class="si">}</span><span class="s2">_constrained.tif&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merged_out</span><span class="p">):</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">] → processing indicator </span><span class="si">{</span><span class="n">ind_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">merge_and_sum_rasters</span><span class="p">(</span><span class="n">filtered_paths</span><span class="p">,</span> <span class="n">merged_out</span><span class="p">,</span> <span class="n">context_log</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] failed to process </span><span class="si">{</span><span class="n">ind_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">] → skipping existing </span><span class="si">{</span><span class="n">ind_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">processed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged_out</span><span class="p">)</span>

    <span class="c1"># 3) Delete raw folder</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir_raw</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">out_dir_raw</span><span class="p">)</span>
        <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country</span><span class="si">}</span><span class="s2">] → deleted raw folder: </span><span class="si">{</span><span class="n">out_dir_raw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">context_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✔ ∙ </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span><span class="si">}</span><span class="s2"> indicators saved under </span><span class="si">{</span><span class="n">out_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">processed</span>


<span class="k">def</span><span class="w"> </span><span class="nf">aggregate_worldpop_to_csv</span><span class="p">(</span><span class="n">country_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">admin_level</span><span class="o">=</span><span class="s2">&quot;ADM2&quot;</span><span class="p">,</span> <span class="n">context_log</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download WorldPop indicators for a country and save CSV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="s2">&quot;Temporary&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="s2">&quot;Output&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context_log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">context_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;worldpop&quot;</span><span class="p">)</span>

    <span class="c1"># 1) Fetch indicators (6 GeoTIFFs) into data/{country}/Temporary</span>
    <span class="n">tifs</span> <span class="o">=</span> <span class="n">fetch_worldpop</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">country_code</span><span class="p">,</span> <span class="n">context_log</span><span class="o">=</span><span class="n">context_log</span><span class="p">)</span>

    <span class="c1"># 2) Load ADM polygons</span>
    <span class="n">adm_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">.geojson&quot;</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">adm_path</span><span class="p">)</span>

    <span class="n">expected_column</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span>
    <span class="k">if</span> <span class="n">expected_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GeoJSON must contain column &#39;</span><span class="si">{</span><span class="n">expected_column</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(found: </span><span class="si">{</span><span class="n">gdf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># 3) Map indicator names to files</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;female_pop&quot;</span><span class="p">,</span><span class="s2">&quot;children_u5&quot;</span><span class="p">,</span><span class="s2">&quot;female_u5&quot;</span><span class="p">,</span><span class="s2">&quot;elderly&quot;</span><span class="p">,</span><span class="s2">&quot;pop_u15&quot;</span><span class="p">,</span><span class="s2">&quot;female_u15&quot;</span><span class="p">]</span>
    <span class="n">tif_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indicators</span><span class="p">,</span> <span class="n">tifs</span><span class="p">))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]</span>

    <span class="c1"># 4) Compute zonal sums</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tif_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>

    <span class="c1"># Round all numeric columns to 0 decimals</span>
    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># 5) Save CSV</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="s2">&quot;Output&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_demographics.csv&quot;</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">csv_path</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="rural-population">
<h2>5. Rural Population<a class="headerlink" href="#rural-population" title="Permalink to this heading">#</a></h2>
<p>Represents the proportion and distribution of people living in <strong>rural areas</strong> within each administrative unit. Rural areas are those outside urban extents, typically characterized by lower population density, agricultural or natural land use, and limited infrastructure compared to urban centers.</p>
<p>This layer combines <strong>WorldPop population rasters</strong> with <strong>Global Human Settlement Layer (GHS-SMOD)</strong> data to estimate rural populations for each demographic group.</p>
<section id="id10">
<h3>Data Sources<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>WorldPop Population Rasters:</strong><br />
Derived from the <a class="reference external" href="https://www.worldpop.org/geodata/listing?id=77">WorldPop Age-Sex structured datasets</a>.<br />
Used to calculate population counts for various demographic indicators (see the <em>Demographics</em> chapter).</p></li>
<li><p><strong>GHS-SMOD (Settlement Model) Raster:</strong><br />
Downloaded from the <a class="reference external" href="https://jeodpp.jrc.ec.europa.eu/ftp/jrc-opendata/GHSL/">JRC GHSL repository</a> for the year 2030 projection.<br />
Used to classify grid cells as <strong>urban</strong> or <strong>rural</strong> based on settlement patterns.</p></li>
<li><p><strong>Administrative Boundaries:</strong><br />
GeoJSON boundary files (e.g., ADM2) define the spatial units used for population aggregation.</p></li>
</ul>
</section>
<section id="id11">
<h3>Processing Steps<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Download GHS-SMOD Raster</strong></p>
<ul class="simple">
<li><p>The script downloads the global SMOD ZIP archive for 2030.</p></li>
<li><p>Extracts and selects the <code class="docutils literal notranslate"><span class="pre">.tif</span></code> raster corresponding to global settlement data.</p></li>
</ul>
</li>
<li><p><strong>Reclassify SMOD Raster</strong></p>
<ul class="simple">
<li><p>Converts original SMOD categories into two classes:</p>
<ul>
<li><p><strong>Rural = 1</strong> (codes 11–13)</p></li>
<li><p><strong>Urban = 2</strong> (codes 21–30)</p></li>
<li><p><strong>Excluded/Water = 0</strong></p></li>
</ul>
</li>
<li><p>The resulting raster is saved as <code class="docutils literal notranslate"><span class="pre">smod_reclass.tif</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Fetch WorldPop Demographic Indicators</strong></p>
<ul class="simple">
<li><p>Ensures that population rasters for indicators such as <code class="docutils literal notranslate"><span class="pre">female_pop</span></code>, <code class="docutils literal notranslate"><span class="pre">children_u5</span></code>, etc., are available.</p></li>
<li><p>Reuses outputs from the <code class="docutils literal notranslate"><span class="pre">Demographics</span></code> asset.</p></li>
</ul>
</li>
<li><p><strong>Compute Rural Population</strong></p>
<ul class="simple">
<li><p>Reprojects the SMOD raster to match each WorldPop raster.</p></li>
<li><p>Multiplies each population raster by the rural mask (<code class="docutils literal notranslate"><span class="pre">smod</span> <span class="pre">==</span> <span class="pre">1</span></code>).</p></li>
<li><p>Performs zonal statistics per administrative unit (e.g., ADM2).</p></li>
</ul>
</li>
<li><p><strong>Output Generation</strong></p>
<ul class="simple">
<li><p>Aggregates results into a CSV file per country and administrative level.</p></li>
<li><p>Adds both absolute (<code class="docutils literal notranslate"><span class="pre">_rural</span></code>) and relative (<code class="docutils literal notranslate"><span class="pre">_rural_perc</span></code>) population values.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id12">
<h3>Outputs<a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>CSV file: <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_rural_population.csv</span></code></p>
<ul>
<li><p>Columns:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{indicator}_rural</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">female_pop_rural</span></code>, <code class="docutils literal notranslate"><span class="pre">children_u5_rural</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rural_pop_perc</span></code> (percentage of population living in rural areas)</p></li>
</ul>
</li>
<li><p>CRS: WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p>Units: counts and percentages per administrative unit</p></li>
</ul>
</li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Rural Population)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rioxarray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rasterstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zonal_stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scripts.fetch_worldpop</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_worldpop</span>

<span class="n">RECLASS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">10</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1"># rural</span>
    <span class="mi">21</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">23</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># urban</span>
<span class="p">}</span>
<span class="n">SMOD_ZIP_URL</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;https://jeodpp.jrc.ec.europa.eu/ftp/jrc-opendata/GHSL/&quot;</span>
    <span class="s2">&quot;GHS_SMOD_GLOBE_R2023A/GHS_SMOD_E2030_GLOBE_R2023A_54009_1000/&quot;</span>
    <span class="s2">&quot;V2-0/GHS_SMOD_E2030_GLOBE_R2023A_54009_1000_V2_0.zip&quot;</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_and_unzip_smod</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download SMOD ZIP, unzip, return path to TIF.&quot;&quot;&quot;</span>
    <span class="n">zip_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;smod.zip&quot;</span>
    <span class="n">unzip_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;unzipped&quot;</span>
    <span class="n">unzip_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Downloading SMOD global raster…&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SMOD_ZIP_URL</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;SMOD ZIP already exists, skipping download.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">unzip_dir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">unzip_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">zip_path</span><span class="p">,</span> <span class="n">unzip_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>

    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No .tif found in SMOD ZIP&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">reclassify_raster</span><span class="p">(</span><span class="n">in_tif</span><span class="p">,</span> <span class="n">out_tif</span><span class="p">,</span> <span class="n">reclass_map</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">in_tif</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">nodata_val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">nodata_val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">reclass_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span> <span class="o">==</span> <span class="n">old</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">mask_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata_val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">mask_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

        <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">nodata_val</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_tif</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reclassified raster saved to </span><span class="si">{</span><span class="n">out_tif</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_rural_population</span><span class="p">(</span><span class="n">country_code</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute rural population counts by admin unit for each indicator.</span>
<span class="sd">    Generates smod_reclass.tif if missing. Skips if output CSV already exists.</span>
<span class="sd">    Adds percentage columns (_rural_perc) for each indicator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_code</span> <span class="o">=</span> <span class="n">country_code</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">work_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/Temporary&quot;</span><span class="p">)</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Temporary&quot;</span><span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">reclass_tif</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="o">/</span> <span class="s2">&quot;smod_reclass.tif&quot;</span>
    <span class="n">out_csv</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_rural_population.csv&quot;</span>

    <span class="c1"># --- skip if CSV exists ---</span>
    <span class="k">if</span> <span class="n">out_csv</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV already exists, skipping: </span><span class="si">{</span><span class="n">out_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_csv</span><span class="p">)</span>

    <span class="n">zip_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unzip_dir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># --- ensure smod_reclass.tif exists ---</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reclass_tif</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;smod_reclass.tif missing — will generate it&quot;</span><span class="p">)</span>
            <span class="n">zip_path</span><span class="p">,</span> <span class="n">unzip_dir</span><span class="p">,</span> <span class="n">smod_tif</span> <span class="o">=</span> <span class="n">download_and_unzip_smod</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">reclassify_raster</span><span class="p">(</span><span class="n">smod_tif</span><span class="p">,</span> <span class="n">reclass_tif</span><span class="p">,</span> <span class="n">RECLASS_MAP</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using existing smod_reclass.tif&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure WorldPop files exist</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensuring demographic rasters exist in </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">indicator_tifs</span> <span class="o">=</span> <span class="n">fetch_worldpop</span><span class="p">(</span><span class="n">country_code</span><span class="p">)</span>
        <span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;female_pop&quot;</span><span class="p">,</span> <span class="s2">&quot;children_u5&quot;</span><span class="p">,</span> <span class="s2">&quot;female_u5&quot;</span><span class="p">,</span> <span class="s2">&quot;elderly&quot;</span><span class="p">,</span> <span class="s2">&quot;pop_u15&quot;</span><span class="p">,</span> <span class="s2">&quot;female_u15&quot;</span><span class="p">]</span>
        <span class="n">tif_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indicators</span><span class="p">,</span> <span class="n">indicator_tifs</span><span class="p">))</span>

        <span class="c1"># --- load SMOD raster ---</span>
        <span class="n">smod</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">reclass_tif</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">rural_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]})</span>

        <span class="c1"># Store total population sums</span>
        <span class="n">total_pop_counts</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">:</span>
            <span class="n">pop_raster_path</span> <span class="o">=</span> <span class="n">tif_map</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">pop_raster</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">pop_raster_path</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="c1"># Align SMOD raster to population raster</span>
            <span class="n">smod_aligned</span> <span class="o">=</span> <span class="n">smod</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">pop_raster</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span><span class="p">)</span>
            <span class="n">rural_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">smod_aligned</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="n">rural_pop</span> <span class="o">=</span> <span class="n">pop_raster</span> <span class="o">*</span> <span class="n">rural_mask</span>

            <span class="n">tmp_rural</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;tmp_rural_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.tif&quot;</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pop_raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span> <span class="n">tiled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">bigtiff</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp_rural</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rural_pop</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Rural population sums per admin unit</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">tmp_rural</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rural_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">_rural&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>

            <span class="c1"># Total population sums per admin unit</span>
            <span class="n">total_stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">pop_raster_path</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">total_pop_counts</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">total_stats</span><span class="p">]</span>

            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed rural population for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- calculate one overall rural percentage column ---</span>
        <span class="c1"># Use total population (e.g. pop_u15 as proxy, or sum of all groups)</span>
        <span class="n">total_pop</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">total_pop_counts</span><span class="p">[</span><span class="s2">&quot;female_pop&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
        <span class="n">rural_df</span><span class="p">[</span><span class="s2">&quot;rural_pop_perc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rural_df</span><span class="p">[</span><span class="s2">&quot;female_pop_rural&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_pop</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># --- finalize ---</span>
        <span class="n">count_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rural_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_rural&quot;</span><span class="p">)]</span>
        <span class="n">perc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rural_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_rural_perc&quot;</span><span class="p">)]</span>

        <span class="c1"># Counts → integers</span>
        <span class="n">rural_df</span><span class="p">[</span><span class="n">count_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">rural_df</span><span class="p">[</span><span class="n">count_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Percentages → keep 2 decimals</span>
        <span class="n">rural_df</span><span class="p">[</span><span class="n">perc_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">rural_df</span><span class="p">[</span><span class="n">perc_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rural_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rural population CSV written to </span><span class="si">{</span><span class="n">out_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># cleanup</span>
        <span class="k">if</span> <span class="n">zip_path</span> <span class="ow">and</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">zip_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">zip_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unzip_dir</span> <span class="ow">and</span> <span class="n">unzip_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">unzip_dir</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">unzip_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
                <span class="c1"># cleanup tmp_rural rasters</span>
        <span class="k">for</span> <span class="n">tmp_file</span> <span class="ow">in</span> <span class="n">work_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;tmp_rural_*.tif&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted </span><span class="si">{</span><span class="n">tmp_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete </span><span class="si">{</span><span class="n">tmp_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="vulnerability">
<h2>6. Vulnerability<a class="headerlink" href="#vulnerability" title="Permalink to this heading">#</a></h2>
<p>Represents the sensitivity of a population to external shocks based on demographic composition and settlement type.<br />
This layer combines <em>Demographics</em> and <em>Rural Population</em> indicators to highlight population groups more likely to experience heightened vulnerability in rural or hard-to-reach regions.</p>
<section id="id13">
<h3>Data Sources<a class="headerlink" href="#id13" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Demographics CSVs:</strong> Derived from <a class="reference external" href="https://www.worldpop.org/">WorldPop</a> population datasets, disaggregated by age and sex (see <em>Demographics</em> chapter).</p></li>
<li><p><strong>Rural Population CSVs:</strong> Derived from settlement layer analysis separating rural and urban populations (see <em>Rural Population</em> chapter).</p></li>
<li><p>Both datasets are aggregated to the same administrative level (e.g., ADM2).</p></li>
</ul>
</section>
<section id="id14">
<h3>Processing Steps<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Input CSVs:</strong></p>
<ul class="simple">
<li><p>One <em>Demographics</em> CSV and one <em>Rural Population</em> CSV are provided per administrative level.</p></li>
<li><p>Each file contains an identifier column such as <code class="docutils literal notranslate"><span class="pre">ADM0_PCODE</span></code>, <code class="docutils literal notranslate"><span class="pre">ADM1_PCODE</span></code>, or <code class="docutils literal notranslate"><span class="pre">ADM2_PCODE</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Column Detection:</strong></p>
<ul class="simple">
<li><p>The script automatically detects the administrative identifier column by finding any column ending with <code class="docutils literal notranslate"><span class="pre">_PCODE</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Merge Operation:</strong></p>
<ul class="simple">
<li><p>The two datasets are merged on the identified <code class="docutils literal notranslate"><span class="pre">*_PCODE</span></code> column using a <strong>left join</strong>.</p></li>
<li><p>This ensures demographic indicators are retained even when some administrative areas lack rural population data.</p></li>
</ul>
</li>
<li><p><strong>Output Generation:</strong></p>
<ul class="simple">
<li><p>The merged dataset is exported as <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_vulnerability.csv</span></code> to the <code class="docutils literal notranslate"><span class="pre">Output/</span></code> directory.</p></li>
<li><p>One file is created per administrative level present in the input data.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id15">
<h3>Outputs<a class="headerlink" href="#id15" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_vulnerability.csv</span></code></p></li>
<li><p><strong>Columns:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p>All demographic indicator columns (e.g., <code class="docutils literal notranslate"><span class="pre">female_pop</span></code>, <code class="docutils literal notranslate"><span class="pre">children_u5</span></code>, <code class="docutils literal notranslate"><span class="pre">elderly</span></code>, <code class="docutils literal notranslate"><span class="pre">pop_u15</span></code>)</p></li>
<li><p>All rural population indicator columns (e.g., <code class="docutils literal notranslate"><span class="pre">rural_pop</span></code>, <code class="docutils literal notranslate"><span class="pre">urban_pop</span></code>, <code class="docutils literal notranslate"><span class="pre">rural_ratio</span></code>)</p></li>
</ul>
</li>
<li><p><strong>CRS:</strong> WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p><strong>Units:</strong> Population counts and ratios aggregated per administrative unit</p></li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python SCript (Vulnerability)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vulnerability_asset</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">demographics_asset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">rural_asset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine demographics and rural population CSVs into a single vulnerability dataset.</span>
<span class="sd">    Joins on the ADM*_PCODE column per admin level.</span>
<span class="sd">    Produces one vulnerability CSV per admin level in Output/.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_code</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">partition_key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">demo_csv</span><span class="p">,</span> <span class="n">rural_csv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">demographics_asset</span><span class="p">,</span> <span class="n">rural_asset</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">demo_csv</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rural_csv</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping merge for </span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">: missing files </span><span class="si">{</span><span class="n">demo_csv</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">rural_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_demo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">demo_csv</span><span class="p">)</span>
            <span class="n">df_rural</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">rural_csv</span><span class="p">)</span>

            <span class="c1"># detect admin code column automatically (ADM0_PCODE, ADM1_PCODE, etc.)</span>
            <span class="n">id_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_demo</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_PCODE&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">id_col</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">demo_csv</span><span class="si">}</span><span class="s2">: no *_PCODE column found&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">id_col</span> <span class="o">=</span> <span class="n">id_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_demo</span><span class="p">,</span> <span class="n">df_rural</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">id_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

            <span class="n">admin_level</span> <span class="o">=</span> <span class="n">id_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># e.g., ADM2</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">country_code</span> <span class="o">/</span> <span class="s2">&quot;Output&quot;</span>
            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_vulnerability.csv&quot;</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>

            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">] Wrote vulnerability CSV: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to merge </span><span class="si">{</span><span class="n">demo_csv</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">rural_csv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No vulnerability outputs created for </span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="crop-coverage-and-change">
<h2>7. Crop Coverage and Change<a class="headerlink" href="#crop-coverage-and-change" title="Permalink to this heading">#</a></h2>
<p>Quantifies the extent and temporal change of cropland areas within administrative boundaries.</p>
<p>This layer evaluates <strong>total cropland coverage</strong> as well as <strong>changes in cropland area</strong> between 2023 and 2024 using <strong>Google Dynamic World (V1)</strong>. This dataset provides 10 m, near-real-time land classification derived from Sentinel-2 imagery. For each administrative unit, the proportion of pixels classified as “cropland” (class 4) is calculated for both years. These percentages are then compared to determine both absolute and relative changes in cropland area.</p>
<section id="id16">
<h3>Data Sources<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Dynamic World V1</strong> (<code class="docutils literal notranslate"><span class="pre">GOOGLE/DYNAMICWORLD/V1</span></code>):<br />
Global, near real-time land cover dataset from Google Earth Engine, with 10 m spatial resolution and daily temporal frequency.</p></li>
<li><p><strong>Administrative Boundaries</strong> (GeoJSON):<br />
Used to aggregate cropland extent within each administrative area (e.g., ADM2).</p></li>
<li><p><strong>Configuration File</strong> (<code class="docutils literal notranslate"><span class="pre">configs/assets_config.yaml</span></code>):<br />
Defines two reference years under <code class="docutils literal notranslate"><span class="pre">crops_asset:</span> <span class="pre">years:</span> <span class="pre">[year1,</span> <span class="pre">year2]</span></code> for comparison.</p></li>
</ul>
</section>
<section id="id17">
<h3>Indicators<a class="headerlink" href="#id17" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Indicator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Units</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">crops_{year1}_pct</span></code></p></td>
<td><p>Percentage of total area classified as crops in the first year</p></td>
<td><p>%</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">crops_{year2}_pct</span></code></p></td>
<td><p>Percentage of total area classified as crops in the second year</p></td>
<td><p>%</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">crops_diff_km2</span></code></p></td>
<td><p>Absolute change in cropland area between the two years</p></td>
<td><p>km²</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">crops_diff_pctpts</span></code></p></td>
<td><p>Percentage point difference in cropland coverage</p></td>
<td><p>% points</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">crops_change_rel_pct</span></code></p></td>
<td><p>Relative percentage change compared to the baseline year</p></td>
<td><p>%</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id18">
<h3>Processing Steps<a class="headerlink" href="#id18" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Configuration Parsing:</strong></p>
<ul class="simple">
<li><p>The script reads <code class="docutils literal notranslate"><span class="pre">assets_config.yaml</span></code> and extracts the two comparison years (e.g., 2018 and 2022).</p></li>
<li><p>If the configuration does not define two valid years, an error is raised.</p></li>
</ul>
</li>
<li><p><strong>Input Geometry:</strong></p>
<ul class="simple">
<li><p>The administrative boundary file <code class="docutils literal notranslate"><span class="pre">data/{country_code}/{country_code}_{admin_level}.geojson</span></code> is loaded using <code class="docutils literal notranslate"><span class="pre">GeoPandas</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Earth Engine Setup:</strong></p>
<ul class="simple">
<li><p>The script initializes Google Earth Engine (<code class="docutils literal notranslate"><span class="pre">ee.Initialize(project=&quot;aa-automatization&quot;)</span></code>).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">GOOGLE/DYNAMICWORLD/V1</span></code> collection is used to generate yearly <strong>mode composites</strong> for each year and boundary polygon.</p></li>
</ul>
</li>
<li><p><strong>Cropland Extraction:</strong></p>
<ul class="simple">
<li><p>Each composite image is classified into Dynamic World labels.</p></li>
<li><p>Label <code class="docutils literal notranslate"><span class="pre">4</span></code> corresponds to <strong>cropland</strong>.</p></li>
<li><p>For each administrative unit, the mean cropland fraction is computed (as % of total area).</p></li>
</ul>
</li>
<li><p><strong>Change Calculation:</strong></p>
<ul class="simple">
<li><p>The following statistics are derived per polygon:</p>
<ul>
<li><p>Percentage of cropland per year (<code class="docutils literal notranslate"><span class="pre">crops_{year1}_pct</span></code>, <code class="docutils literal notranslate"><span class="pre">crops_{year2}_pct</span></code>)</p></li>
<li><p>Absolute area change in km² (<code class="docutils literal notranslate"><span class="pre">crops_diff_km2</span></code>)</p></li>
<li><p>Difference in percentage points (<code class="docutils literal notranslate"><span class="pre">crops_diff_pctpts</span></code>)</p></li>
<li><p>Relative change compared to the first year (<code class="docutils literal notranslate"><span class="pre">crops_change_rel_pct</span></code>)</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Chunked Processing:</strong></p>
<ul class="simple">
<li><p>To handle large datasets, polygons are processed in chunks (default: 20 features at a time).</p></li>
<li><p>Each chunk’s results are written to a temporary CSV, then appended to the final output.</p></li>
</ul>
</li>
<li><p><strong>Output Generation:</strong></p>
<ul class="simple">
<li><p>The combined dataset is saved as <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_crops.csv</span></code> under <code class="docutils literal notranslate"><span class="pre">data/{country_code}/Output/</span></code>.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id19">
<h3>Outputs<a class="headerlink" href="#id19" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_crops.csv</span></code></p></li>
<li><p><strong>Columns:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">crops_{year1}_pct</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">crops_{year2}_pct</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">crops_diff_km2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">crops_diff_pctpts</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">crops_change_rel_pct</span></code></p></li>
</ul>
</li>
<li><p><strong>CRS:</strong> WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p><strong>Units:</strong> Percentages (%) and area (km²)</p></li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Crop Coverage and Change)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geemap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ee</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_years_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;configs/assets_config.yaml&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load years from crops_asset in assets_config.yaml&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crops_asset&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;years&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">years</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;assets_config.yaml must define crops_asset: years: [year1, year2]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">years</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process_crops_for_admin</span><span class="p">(</span><span class="n">country_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;configs/assets_config.yaml&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run crop coverage calculation for a given country/admin level and return output CSV path.&quot;&quot;&quot;</span>

    <span class="c1"># Initialize Earth Engine</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s2">&quot;aa-automatization&quot;</span><span class="p">)</span>

    <span class="n">year_prev</span><span class="p">,</span> <span class="n">year_curr</span> <span class="o">=</span> <span class="n">load_years_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>

    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Ensure Output folder exists</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Output&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Output/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_crops.csv&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_csv</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_csv</span><span class="p">)</span>

    <span class="n">col_order</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;crops_</span><span class="si">{</span><span class="n">year_prev</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;crops_</span><span class="si">{</span><span class="n">year_curr</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;crops_diff_km2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;crops_diff_pctpts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;crops_change_rel_pct&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">dw</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;GOOGLE/DYNAMICWORLD/V1&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">yearly_composite</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">geom</span><span class="p">):</span>
        <span class="n">coll</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dw</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">coll</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>

    <span class="k">while</span> <span class="n">start_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">):</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">chunk_size</span>
        <span class="n">gdf_chunk</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">geemap</span><span class="o">.</span><span class="n">geopandas_to_ee</span><span class="p">(</span><span class="n">gdf_chunk</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">add_crops_stats</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
                <span class="n">comp_prev</span> <span class="o">=</span> <span class="n">yearly_composite</span><span class="p">(</span><span class="n">year_prev</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
                <span class="n">comp_curr</span> <span class="o">=</span> <span class="n">yearly_composite</span><span class="p">(</span><span class="n">year_curr</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>

                <span class="n">polygon_area_km2</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">area</span><span class="p">())</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>

                <span class="n">crop_prev_raw</span> <span class="o">=</span> <span class="n">comp_prev</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;crops&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                    <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crops&quot;</span><span class="p">)</span>

                <span class="n">crop_curr_raw</span> <span class="o">=</span> <span class="n">comp_curr</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;crops&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                    <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crops&quot;</span><span class="p">)</span>

                <span class="n">crop_prev_perc</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">crop_prev_raw</span><span class="p">,</span> <span class="n">crop_prev_raw</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">crop_curr_perc</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">crop_curr_raw</span><span class="p">,</span> <span class="n">crop_curr_raw</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">crops_perc_point_dif</span> <span class="o">=</span> <span class="n">crop_curr_perc</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">crop_prev_perc</span><span class="p">)</span>
                <span class="n">crops_abs_dif_km2</span> <span class="o">=</span> <span class="n">crops_perc_point_dif</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">polygon_area_km2</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

                <span class="n">crops_rel_change_perc</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span>
                    <span class="n">crop_prev_perc</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">crops_perc_point_dif</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">crop_prev_perc</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">set</span><span class="p">({</span>
                    <span class="sa">f</span><span class="s2">&quot;crops_</span><span class="si">{</span><span class="n">year_prev</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">:</span> <span class="n">crop_prev_perc</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;crops_</span><span class="si">{</span><span class="n">year_curr</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">:</span> <span class="n">crop_curr_perc</span><span class="p">,</span>
                    <span class="s2">&quot;crops_diff_km2&quot;</span><span class="p">:</span> <span class="n">crops_abs_dif_km2</span><span class="p">,</span>
                    <span class="s2">&quot;crops_diff_pctpts&quot;</span><span class="p">:</span> <span class="n">crops_perc_point_dif</span><span class="p">,</span>
                    <span class="s2">&quot;crops_change_rel_pct&quot;</span><span class="p">:</span> <span class="n">crops_rel_change_perc</span><span class="p">,</span>
                <span class="p">})</span>

            <span class="n">fc_with_stats</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">add_crops_stats</span><span class="p">)</span>
            <span class="n">fc_filtered</span> <span class="o">=</span> <span class="n">fc_with_stats</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">propertySelectors</span><span class="o">=</span><span class="n">col_order</span><span class="p">,</span> <span class="n">retainGeometry</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

            <span class="n">temp_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_crops_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_temp_chunk.csv&quot;</span>
            <span class="n">geemap</span><span class="o">.</span><span class="n">ee_to_csv</span><span class="p">(</span><span class="n">fc_filtered</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">temp_csv</span><span class="p">)</span>

            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">temp_csv</span><span class="p">)</span>
            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">df_chunk</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_order</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_chunk</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
            <span class="n">df_chunk</span><span class="p">[</span><span class="n">col_order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="n">df_chunk</span><span class="p">[</span><span class="n">col_order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_csv</span><span class="p">):</span>
                <span class="n">df_chunk</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_chunk</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_csv</span><span class="p">)</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>

    <span class="k">return</span> <span class="n">output_csv</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="vegetation-index">
<h2>8. Vegetation Index<a class="headerlink" href="#vegetation-index" title="Permalink to this heading">#</a></h2>
<p>Evaluates vegetation health and density using the <strong>Normalized Difference Vegetation Index (NDVI)</strong> derived from <strong>Landsat</strong> composites. NDVI values range from -1 to +1, where higher values indicate denser and healthier vegetation, while lower values reflect sparse or stressed vegetation, bare soil, or urban surfaces.</p>
<p>This layer provides summary statistics (mean, median, quartiles) and surface extent of high, medium, and low NDVI zones per administrative boundary.</p>
<section id="id20">
<h3>Data Sources<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Landsat NDVI Composite</strong> (<code class="docutils literal notranslate"><span class="pre">LANDSAT/COMPOSITES/C02/T1_L2_8DAY_NDVI</span></code>):<br />
8-day composite product containing NDVI values at 30 m resolution.</p></li>
<li><p><strong>Administrative Boundaries</strong> (GeoJSON):<br />
Used for spatial aggregation at ADM levels (e.g., ADM2).</p></li>
<li><p><strong>Configuration File</strong> (<code class="docutils literal notranslate"><span class="pre">configs/assets_config.yaml</span></code>):<br />
Defines the target year under <code class="docutils literal notranslate"><span class="pre">ndvi_asset:</span> <span class="pre">year:</span> <span class="pre">[YYYY]</span></code>.</p></li>
</ul>
</section>
<section id="id21">
<h3>Indicators<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Indicator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Units</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_mean</span></code></p></td>
<td><p>Mean NDVI value across the administrative unit</p></td>
<td><p>NDVI (unitless)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_median</span></code></p></td>
<td><p>Median NDVI value</p></td>
<td><p>NDVI (unitless)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_p25</span></code></p></td>
<td><p>25th percentile NDVI</p></td>
<td><p>NDVI (unitless)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_p75</span></code></p></td>
<td><p>75th percentile NDVI</p></td>
<td><p>NDVI (unitless)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_high_sqkm</span></code></p></td>
<td><p>Area with NDVI ≥ 0.6</p></td>
<td><p>km²</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_medium_sqkm</span></code></p></td>
<td><p>Area with 0.1 ≤ NDVI &lt; 0.6</p></td>
<td><p>km²</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">NDVI_low_sqkm</span></code></p></td>
<td><p>Area with NDVI &lt; 0.1</p></td>
<td><p>km²</p></td>
</tr>
</tbody>
</table>
</section>
<section id="ndvi-thresholds">
<h3>NDVI Thresholds<a class="headerlink" href="#ndvi-thresholds" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Category</p></th>
<th class="head"><p>NDVI Range</p></th>
<th class="head"><p>Interpretation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>High NDVI</strong></p></td>
<td><p>≥ 0.6</p></td>
<td><p>Dense vegetation (forests, crops, green cover)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Medium NDVI</strong></p></td>
<td><p>0.1 – 0.6</p></td>
<td><p>Moderate vegetation (grasslands, shrubs, mixed use)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Low NDVI</strong></p></td>
<td><p>&lt; 0.1</p></td>
<td><p>Bare soil, urban areas, or degraded vegetation</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id22">
<h3>Processing Steps<a class="headerlink" href="#id22" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Configuration Loading</strong></p>
<ul class="simple">
<li><p>Extracts <code class="docutils literal notranslate"><span class="pre">year</span></code> from <code class="docutils literal notranslate"><span class="pre">assets_config.yaml</span></code> (<code class="docutils literal notranslate"><span class="pre">ndvi_asset:</span> <span class="pre">year:</span> <span class="pre">[YYYY]</span></code>).</p></li>
<li><p>The script ensures exactly one valid year is defined.</p></li>
</ul>
</li>
<li><p><strong>Input Geometry</strong></p>
<ul class="simple">
<li><p>Loads administrative boundaries (<code class="docutils literal notranslate"><span class="pre">data/{country_code}/{country_code}_{admin_level}.geojson</span></code>) using GeoPandas.</p></li>
</ul>
</li>
<li><p><strong>Earth Engine Initialization</strong></p>
<ul class="simple">
<li><p>Connects to Google Earth Engine under the project <code class="docutils literal notranslate"><span class="pre">aa-automatization</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Landsat NDVI Aggregation</strong></p>
<ul class="simple">
<li><p>Loads Landsat NDVI composites for the specified year.</p></li>
<li><p>Calculates the <strong>median NDVI</strong> across the year to reduce noise from clouds and seasonal variation.</p></li>
</ul>
</li>
<li><p><strong>NDVI Classification</strong></p>
<ul class="simple">
<li><p>Creates three NDVI masks:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">High</span></code>: NDVI ≥ 0.6</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Medium</span></code>: 0.1 ≤ NDVI &lt; 0.6</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Low</span></code>: NDVI &lt; 0.1</p></li>
</ul>
</li>
<li><p>Each mask is used to compute the corresponding surface area in square kilometers.</p></li>
</ul>
</li>
<li><p><strong>Statistical Summary per Polygon</strong></p>
<ul class="simple">
<li><p>Calculates the following metrics using <code class="docutils literal notranslate"><span class="pre">ee.Reducer</span></code>:</p>
<ul>
<li><p>Mean, Median, 25th and 75th Percentile NDVI</p></li>
<li><p>Area (km²) for each NDVI category</p></li>
</ul>
</li>
<li><p>Areas are calculated from pixel counts (<code class="docutils literal notranslate"><span class="pre">count</span> <span class="pre">×</span> <span class="pre">900</span> <span class="pre">/</span> <span class="pre">1,000,000</span></code>).</p></li>
</ul>
</li>
<li><p><strong>Chunked Processing</strong></p>
<ul class="simple">
<li><p>Polygons are processed in chunks (default: 20).</p></li>
<li><p>Reduces API payload errors when handling large datasets.</p></li>
<li><p>If payloads exceed limits, chunk size automatically decreases.</p></li>
</ul>
</li>
<li><p><strong>Output Generation</strong></p>
<ul class="simple">
<li><p>Each chunk’s results are exported to temporary CSVs and appended to<br />
<code class="docutils literal notranslate"><span class="pre">data/{country_code}/Output/{country_code}_{admin_level}_ndvi.csv</span></code>.</p></li>
<li><p>Final columns are reordered and rounded to 2 decimals for clarity.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id23">
<h3>Outputs<a class="headerlink" href="#id23" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_ndvi.csv</span></code></p></li>
<li><p><strong>Columns:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_mean</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_median</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_p25</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_p75</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_high_sqkm</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_medium_sqkm</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NDVI_low_sqkm</span></code></p></li>
</ul>
</li>
<li><p><strong>CRS:</strong> WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p><strong>Units:</strong> NDVI (unitless), Area (km²)</p></li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Vegetation Index)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geemap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ee</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

<span class="k">def</span><span class="w"> </span><span class="nf">load_year_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;configs/assets_config.yaml&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load year from ndvi_asset in assets_config.yaml&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ndvi_asset&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">year</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;assets_config.yaml must define ndvi_asset: year: [year]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_ndvi_for_admin</span><span class="p">(</span><span class="n">country_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;configs/assets_config.yaml&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run NDVI calculation for a given country/admin level and return output CSV path.&quot;&quot;&quot;</span>
    <span class="c1"># Initialize Earth Engine</span>
    <span class="n">ee</span><span class="o">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;aa-automatization&#39;</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">load_year_from_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Output&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Output/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_ndvi.csv&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_csv</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_csv</span><span class="p">)</span>

    <span class="n">col_order</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NDVI_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_median&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_p25&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_p75&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NDVI_high_sqkm&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_medium_sqkm&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_low_sqkm&quot;</span>
    <span class="p">]</span>

    <span class="k">while</span> <span class="n">start_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gdf</span><span class="p">):</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">chunk_size</span>
        <span class="n">gdf_chunk</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="n">geemap</span><span class="o">.</span><span class="n">geopandas_to_ee</span><span class="p">(</span><span class="n">gdf_chunk</span><span class="p">)</span>

            <span class="n">landsat</span> <span class="o">=</span> <span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="s2">&quot;LANDSAT/COMPOSITES/C02/T1_L2_8DAY_NDVI&quot;</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">filterBounds</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>

            <span class="n">ndvi_image</span> <span class="o">=</span> <span class="n">landsat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;NDVI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

            <span class="n">high_ndvi_mask</span> <span class="o">=</span> <span class="n">ndvi_image</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ndvi_image</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mf">0.6</span><span class="p">))</span>
            <span class="n">medium_ndvi_mask</span> <span class="o">=</span> <span class="n">ndvi_image</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ndvi_image</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">ndvi_image</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)))</span>
            <span class="n">low_ndvi_mask</span> <span class="o">=</span> <span class="n">ndvi_image</span><span class="o">.</span><span class="n">updateMask</span><span class="p">(</span><span class="n">ndvi_image</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">add_stats</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">ndvi_image</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                    <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">percentile</span><span class="p">([</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">]),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="n">high_count</span> <span class="o">=</span> <span class="n">high_ndvi_mask</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                    <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">medium_count</span> <span class="o">=</span> <span class="n">medium_ndvi_mask</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                    <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">low_count</span> <span class="o">=</span> <span class="n">low_ndvi_mask</span><span class="o">.</span><span class="n">reduceRegion</span><span class="p">(</span>
                    <span class="n">reducer</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                    <span class="n">geometry</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">geometry</span><span class="p">(),</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                    <span class="n">bestEffort</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

                <span class="n">high_count</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">high_count</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">900</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">))</span>
                <span class="n">medium_count</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">medium_count</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">900</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">))</span>
                <span class="n">low_count</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">low_count</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">900</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">))</span>

                <span class="n">all_stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">high_count</span><span class="p">)</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">medium_count</span><span class="p">)</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">low_count</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">feature</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">all_stats</span><span class="p">)</span>

            <span class="n">fc_with_stats</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">add_stats</span><span class="p">)</span>
            <span class="n">fc_filtered</span> <span class="o">=</span> <span class="n">fc_with_stats</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                <span class="s1">&#39;propertySelectors&#39;</span><span class="p">:</span> <span class="n">col_order</span><span class="p">,</span>
                <span class="s1">&#39;retainGeometry&#39;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">})</span>

            <span class="n">temp_csv</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_ndvi_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_temp_chunk.csv&quot;</span>
            <span class="n">geemap</span><span class="o">.</span><span class="n">ee_to_csv</span><span class="p">(</span><span class="n">fc_filtered</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">temp_csv</span><span class="p">)</span>

            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">temp_csv</span><span class="p">)</span>
            <span class="n">df_chunk</span> <span class="o">=</span> <span class="n">df_chunk</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col_order</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_chunk</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>

            <span class="n">round_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NDVI_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_median&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_p25&quot;</span><span class="p">,</span> <span class="s2">&quot;NDVI_p75&quot;</span><span class="p">]</span>
            <span class="n">df_chunk</span><span class="p">[</span><span class="n">round_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_chunk</span><span class="p">[</span><span class="n">round_cols</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_csv</span><span class="p">):</span>
                <span class="n">df_chunk</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_chunk</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_csv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed chunk </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end_idx</span><span class="si">}</span><span class="s2"> (size </span><span class="si">{</span><span class="n">chunk_size</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>

        <span class="k">except</span> <span class="n">ee</span><span class="o">.</span><span class="n">EEException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Request payload size exceeds the limit&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Payload too large. Reducing chunk size to </span><span class="si">{</span><span class="n">chunk_size</span><span class="si">}</span><span class="s2"> and retrying index </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chunk size 1 still too large. Skipping index </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EEException: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping chunk.&quot;</span><span class="p">)</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temp CSV not found. Retrying index </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2"> with smaller chunk...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping chunk </span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">end_idx</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span>

    <span class="k">return</span> <span class="n">output_csv</span>
</pre></div>
</div>
</div>
</details></section>
</section>
<hr class="docutils" />
<section id="flood-exposure">
<h2>9. Flood Exposure<a class="headerlink" href="#flood-exposure" title="Permalink to this heading">#</a></h2>
<p>Estimates population and facility exposure to flooding using <strong>GLOFAS flood hazard rasters</strong> and <strong>WorldPop demographic layers</strong>. Flooded areas are identified by usign a threshold of 30 cm, and exposure metrics are aggregated per administrative boundary.</p>
<p>This layer provides indicators for the number of people affected per demographic group and the percentage/count of critical facilities (education, hospitals, primary healthcare) impacted by flood events of different return periods (RPs).</p>
<section id="id24">
<h3>Data Sources<a class="headerlink" href="#id24" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>GLOFAS Flood Hazard Rasters</strong> (<code class="docutils literal notranslate"><span class="pre">https://jeodpp.jrc.ec.europa.eu/ftp/jrc-opendata/CEMS-GLOFAS/flood_hazard/</span></code>)<br />
Raster tiles containing flood depth values for different return periods (RPs).</p></li>
<li><p><strong>WorldPop Population Layers</strong> (<code class="docutils literal notranslate"><span class="pre">scripts/fetch_worldpop.py</span></code>)<br />
Demographic rasters for multiple indicators at ~100 m resolution: total population, female, children under 5, elderly, etc.</p></li>
<li><p><strong>Facilities Data</strong> (<code class="docutils literal notranslate"><span class="pre">scripts/fetch_facilities_ohsome_overpass.py</span></code>)<br />
Point geometries of critical infrastructure from OHSOME or Overpass APIs.</p></li>
<li><p><strong>Administrative Boundaries</strong> (GeoJSON)<br />
Used to aggregate flood exposure per ADM level (e.g., ADM1).</p></li>
<li><p><strong>Configuration File</strong> (<code class="docutils literal notranslate"><span class="pre">configs/assets_config.yaml</span></code>)<br />
Specifies:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">setup.flood_threshold</span></code> (flood depth in meters)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">setup.rps</span></code> (return periods)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">facilities_asset.api</span></code> (data source for facilities)</p></li>
</ul>
</li>
</ul>
</section>
<section id="id25">
<h3>Indicators<a class="headerlink" href="#id25" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Indicator</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Units</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_female_pop_{thresh}</span></code></p></td>
<td><p>Number of females affected by flood depth ≥ threshold</p></td>
<td><p>people</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_children_u5_{thresh}</span></code></p></td>
<td><p>Number of children under 5 affected</p></td>
<td><p>people</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_female_u5_{thresh}</span></code></p></td>
<td><p>Number of female children under 5 affected</p></td>
<td><p>people</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_elderly_{thresh}</span></code></p></td>
<td><p>Number of elderly (&gt;65) affected</p></td>
<td><p>people</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_pop_u15_{thresh}</span></code></p></td>
<td><p>Number of population under 15 affected</p></td>
<td><p>people</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_female_u15_{thresh}</span></code></p></td>
<td><p>Number of female population under 15 affected</p></td>
<td><p>people</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_education_{thresh}_pct</span></code></p></td>
<td><p>Percentage of educational facilities flooded</p></td>
<td><p>%</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_education_{thresh}_count</span></code></p></td>
<td><p>Number of educational facilities flooded</p></td>
<td><p>count</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_hospitals_{thresh}_pct</span></code></p></td>
<td><p>Percentage of hospitals flooded</p></td>
<td><p>%</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_hospitals_{thresh}_count</span></code></p></td>
<td><p>Number of hospitals flooded</p></td>
<td><p>count</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_primary_healthcare_{thresh}_pct</span></code></p></td>
<td><p>Percentage of primary healthcare facilities flooded</p></td>
<td><p>%</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">RP{rp}_primary_healthcare_{thresh}_count</span></code></p></td>
<td><p>Number of primary healthcare facilities flooded</p></td>
<td><p>count</p></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">{rp}</span></code> is the return period (e.g., 10, 50, 100 years), <code class="docutils literal notranslate"><span class="pre">{thresh}</span></code> is the flood threshold in cm.</p>
</div></blockquote>
</section>
<section id="flood-threshold">
<h3>Flood Threshold<a class="headerlink" href="#flood-threshold" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">setup.flood_threshold</span></code></p></td>
<td><p>e.g., 0.3 m</p></td>
<td><p>Minimum flood depth considered for exposure (configurable in <code class="docutils literal notranslate"><span class="pre">assets_config.yaml</span></code>)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id26">
<h3>Processing Steps<a class="headerlink" href="#id26" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Configuration Loading</strong></p>
<ul class="simple">
<li><p>Reads <code class="docutils literal notranslate"><span class="pre">setup.flood_threshold</span></code> and <code class="docutils literal notranslate"><span class="pre">rps</span></code> from <code class="docutils literal notranslate"><span class="pre">assets_config.yaml</span></code>.</p></li>
<li><p>Computes <code class="docutils literal notranslate"><span class="pre">THRESH_SUFFIX</span></code> (flood depth in cm) for indicator naming.</p></li>
</ul>
</li>
<li><p><strong>Input Geometry</strong></p>
<ul class="simple">
<li><p>Loads administrative boundaries (<code class="docutils literal notranslate"><span class="pre">data/{country_code}/{country_code}_{admin_level}.geojson</span></code>) using GeoPandas.</p></li>
</ul>
</li>
<li><p><strong>Tile Selection and Download</strong></p>
<ul class="simple">
<li><p>Queries GLOFAS server for all flood tiles corresponding to each RP.</p></li>
<li><p>Selects only tiles intersecting the country boundary.</p></li>
<li><p>Downloads missing tiles into <code class="docutils literal notranslate"><span class="pre">data/{country_code}/Temporary</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Raster Merging and Clipping</strong></p>
<ul class="simple">
<li><p>Merges selected tiles into a single raster per RP.</p></li>
<li><p>Clips the merged raster to the country boundary and saves to <code class="docutils literal notranslate"><span class="pre">Temporary</span></code>.</p></li>
</ul>
</li>
<li><p><strong>WorldPop Population Preparation</strong></p>
<ul class="simple">
<li><p>Fetches required demographic rasters (total population, female, children under 5, elderly, etc.).</p></li>
<li><p>Ensures rasters exist locally for alignment with flood data.</p></li>
</ul>
</li>
<li><p><strong>Facility Data Preparation</strong></p>
<ul class="simple">
<li><p>Downloads or loads facilities geometries from the chosen API (<code class="docutils literal notranslate"><span class="pre">ohsome-api</span></code>, <code class="docutils literal notranslate"><span class="pre">overpass</span></code>).</p></li>
<li><p>Converts geometries to points and reprojects to match raster CRS.</p></li>
</ul>
</li>
<li><p><strong>Flood Exposure Calculation per RP</strong></p>
<ul class="simple">
<li><p><strong>Flooded population</strong>: Multiplies population raster by flood mask (flood depth ≥ threshold) to compute the number of affected people per ADM polygon.</p></li>
<li><p><strong>Flooded facilities</strong>: Samples flood raster at facility locations to compute flooded count and percentage per ADM polygon.</p></li>
</ul>
</li>
<li><p><strong>Aggregation and CSV Output</strong></p>
<ul class="simple">
<li><p>Merges RP results across population and facilities into a single CSV.</p></li>
<li><p>Fills missing values with 0 and rounds numbers to integers.</p></li>
<li><p>Final CSV saved to <code class="docutils literal notranslate"><span class="pre">data/{country_code}/Output/{country_code}_{admin_level}_flood_exposure.csv</span></code>.</p></li>
</ul>
</li>
</ol>
</section>
<section id="id27">
<h3>Outputs<a class="headerlink" href="#id27" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>File:</strong> <code class="docutils literal notranslate"><span class="pre">{country_code}_{admin_level}_flood_exposure.csv</span></code></p></li>
<li><p><strong>Columns:</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">{admin_level}_PCODE</span></code></p></li>
<li><p>Flooded population indicators per RP</p></li>
<li><p>Flooded facilities indicators per RP</p></li>
</ul>
</li>
<li><p><strong>CRS:</strong> WGS84 (<code class="docutils literal notranslate"><span class="pre">EPSG:4326</span></code>)</p></li>
<li><p><strong>Units:</strong> people, %, count</p></li>
</ul>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
Python Script (Flood Exposure)<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.merge</span><span class="w"> </span><span class="kn">import</span> <span class="n">merge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.mask</span><span class="w"> </span><span class="kn">import</span> <span class="n">mask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zonal_stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.enums</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resampling</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rioxarray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scripts.fetch_worldpop</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_worldpop</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scripts.fetch_facilities_ohsome_overpass</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_overpass</span><span class="p">,</span> <span class="n">fetch_ohsome</span>

<span class="n">ASSET_CONFIG_YAML_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;configs&quot;</span><span class="p">,</span> <span class="s2">&quot;assets_config.yaml&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ASSET_CONFIG_YAML_PATH</span><span class="p">)</span> <span class="k">as</span> <span class="n">_fp</span><span class="p">:</span>
    <span class="n">_asset_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">_fp</span><span class="p">)</span>

<span class="n">BASE_URL_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;https://jeodpp.jrc.ec.europa.eu/ftp/jrc-opendata/CEMS-GLOFAS/flood_hazard/</span><span class="si">{rp}</span><span class="s2">/&quot;</span>
<span class="n">ALLOWED_RPS</span> <span class="o">=</span> <span class="n">_asset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rps&quot;</span><span class="p">,</span> <span class="p">[])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">FLOOD_THRESHOLD</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_asset_config</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">][</span><span class="s2">&quot;flood_threshold&quot;</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;setup.flood_threshold&#39; in assets_config.yaml&quot;</span><span class="p">)</span>

<span class="n">THRESH_SUFFIX</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">FLOOD_THRESHOLD</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">cm&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_listing</span><span class="p">(</span><span class="n">rp</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;href=&quot;([^&quot;]+_RP</span><span class="si">{}</span><span class="s1">_depth\.tif)&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">tile_bounds_from_filename</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_(N|S)(\d+)_([EW])(\d+)_RP&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">lat_sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">lat_sign</span>
    <span class="n">lon_sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">*</span> <span class="n">lon_sign</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">lon</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">-</span> <span class="mi">10</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bbox_intersects</span><span class="p">(</span><span class="n">tile_bbox</span><span class="p">,</span> <span class="n">geom_bbox</span><span class="p">):</span>
    <span class="n">txmin</span><span class="p">,</span> <span class="n">tymin</span><span class="p">,</span> <span class="n">txmax</span><span class="p">,</span> <span class="n">tymax</span> <span class="o">=</span> <span class="n">tile_bbox</span>
    <span class="n">gxmin</span><span class="p">,</span> <span class="n">gymin</span><span class="p">,</span> <span class="n">gxmax</span><span class="p">,</span> <span class="n">gymax</span> <span class="o">=</span> <span class="n">geom_bbox</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">txmax</span> <span class="o">&lt;=</span> <span class="n">gxmin</span> <span class="ow">or</span> <span class="n">txmin</span> <span class="o">&gt;=</span> <span class="n">gxmax</span> <span class="ow">or</span> <span class="n">tymax</span> <span class="o">&lt;=</span> <span class="n">gymin</span> <span class="ow">or</span> <span class="n">tymin</span> <span class="o">&gt;=</span> <span class="n">gymax</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">temporary_dir</span><span class="p">,</span> <span class="n">rp</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fname</span>
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temporary_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">):</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already exists: </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outpath</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">64</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outpath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process_country_rp</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">admin_level</span><span class="o">=</span><span class="s2">&quot;ADM0&quot;</span><span class="p">):</span>
    <span class="n">temporary_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Temporary&quot;</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">/Output&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">temporary_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">clipped_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temporary_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_flooded_RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">clipped_path</span><span class="p">):</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipped raster already exists: </span><span class="si">{</span><span class="n">clipped_path</span><span class="si">}</span><span class="s2">, skipping ...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clipped_path</span>

    <span class="n">boundary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">.geojson&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">boundary_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boundary file not found: </span><span class="si">{</span><span class="n">boundary_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">boundary_file</span><span class="p">)</span>
    <span class="n">gxmin</span><span class="p">,</span> <span class="n">gymin</span><span class="p">,</span> <span class="n">gxmax</span><span class="p">,</span> <span class="n">gymax</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">total_bounds</span>
    <span class="n">geom_bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">gxmin</span><span class="p">,</span> <span class="n">gymin</span><span class="p">,</span> <span class="n">gxmax</span><span class="p">,</span> <span class="n">gymax</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boundary BBOX for </span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">geom_bbox</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">parse_listing</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> tiles on server for RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="p">(</span><span class="n">tb</span> <span class="o">:=</span> <span class="n">tile_bounds_from_filename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="ow">and</span> <span class="n">bbox_intersects</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">geom_bbox</span><span class="p">)]</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span><span class="si">}</span><span class="s2"> tiles to download.&quot;</span><span class="p">)</span>

    <span class="n">tile_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_file</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">temporary_dir</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>
    <span class="n">tile_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tile_paths</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tile_paths</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No tiles downloaded for RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merging tiles...&quot;</span><span class="p">)</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tile_paths</span><span class="p">]</span>
    <span class="n">mosaic</span><span class="p">,</span> <span class="n">out_trans</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span>

    <span class="n">out_meta</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">out_trans</span><span class="p">,</span>
        <span class="s2">&quot;compress&quot;</span><span class="p">:</span> <span class="s2">&quot;lzw&quot;</span>
    <span class="p">})</span>

    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Clipping merged raster to boundary...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
        <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="n">geoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span> <span class="k">for</span> <span class="n">geom</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">MemoryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">memfile</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">memfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mosaic</span><span class="p">)</span>
            <span class="n">out_image</span><span class="p">,</span> <span class="n">out_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">geoms</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">out_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">out_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">out_transform</span>
    <span class="p">})</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">clipped_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_image</span><span class="p">)</span>

    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipped raster saved to </span><span class="si">{</span><span class="n">clipped_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">srcs</span><span class="p">:</span>
        <span class="n">src</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">clipped_path</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process_flood_impact</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">rps</span><span class="p">,</span> <span class="n">gdf</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process flooded population for all RPs of a given country/admin_level.</span>
<span class="sd">    Generates a single CSV with columns for each RP, indicator, threshold,</span>
<span class="sd">    and percentage of facilities flooded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">country_code</span> <span class="o">=</span> <span class="n">country_code</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">out_csv</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_flood_exposure.csv&quot;</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">country_code</span> <span class="o">/</span> <span class="s2">&quot;Temporary&quot;</span>

    <span class="c1"># Load existing CSV if present, to append missing RPs</span>
    <span class="k">if</span> <span class="n">out_csv</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV exists: </span><span class="si">{</span><span class="n">out_csv</span><span class="si">}</span><span class="s2">, will append missing RPs&quot;</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">out_csv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]})</span>

    <span class="c1"># Ensure WorldPop files exist</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensuring demographic rasters exist in </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">indicator_tifs</span> <span class="o">=</span> <span class="n">fetch_worldpop</span><span class="p">(</span><span class="n">country_code</span><span class="p">)</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;female_pop&quot;</span><span class="p">,</span> <span class="s2">&quot;children_u5&quot;</span><span class="p">,</span> <span class="s2">&quot;female_u5&quot;</span><span class="p">,</span> <span class="s2">&quot;elderly&quot;</span><span class="p">,</span> <span class="s2">&quot;pop_u15&quot;</span><span class="p">,</span> <span class="s2">&quot;female_u15&quot;</span><span class="p">]</span>
    <span class="n">tif_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indicators</span><span class="p">,</span> <span class="n">indicator_tifs</span><span class="p">))</span>

    <span class="c1"># Ensure facilities exist</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensuring facility raw geometries exist in </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">base_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">country_code</span>
    <span class="n">boundary_path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">.geojson&quot;</span>
    <span class="n">api_choice</span> <span class="o">=</span> <span class="n">_asset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;facilities_asset&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">api_choice</span> <span class="o">==</span> <span class="s2">&quot;ohsome-api&quot;</span><span class="p">:</span>
        <span class="n">summary_path</span> <span class="o">=</span> <span class="n">fetch_ohsome</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span> <span class="n">boundary_path</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">admin_level</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">api_choice</span> <span class="o">==</span> <span class="s2">&quot;overpass&quot;</span><span class="p">:</span>
        <span class="n">summary_path</span> <span class="o">=</span> <span class="n">fetch_overpass</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span> <span class="n">boundary_path</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">admin_level</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">api_choice</span> <span class="o">==</span> <span class="s2">&quot;ohsome-parquet&quot;</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not implemented yet: ohsome-parquet&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No valid API configured for facilities_asset (got &#39;</span><span class="si">{</span><span class="n">api_choice</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">geojsons_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">facility_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">,</span> <span class="s2">&quot;hospitals&quot;</span><span class="p">,</span> <span class="s2">&quot;primary_healthcare&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">facility_categories</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">geojsons_map</span><span class="p">:</span>
            <span class="n">geojsons_map</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Temporary/</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_raw.geojson&quot;</span>

    <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">rps</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

        <span class="c1"># Skip RP if all expected columns already exist</span>
        <span class="n">expected_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">indicators</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">THRESH_SUFFIX</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">_pct&quot;</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">facility_categories</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">THRESH_SUFFIX</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">_count&quot;</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">facility_categories</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">THRESH_SUFFIX</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">final_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expected_cols</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2"> already processed, skipping...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Flood raster clipped to country</span>
        <span class="n">clipped_path</span> <span class="o">=</span> <span class="n">process_country_rp</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">country_code</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">admin_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clipped_path</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No flood raster for RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">, skipping...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">flood</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">clipped_path</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">rp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">:</span> <span class="n">gdf</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">]})</span>

        <span class="c1"># ---- Flooded population ----</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">indicators</span><span class="p">:</span>
            <span class="n">pop_raster_path</span> <span class="o">=</span> <span class="n">tif_map</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">pop_raster</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">pop_raster_path</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="n">flood_aligned</span> <span class="o">=</span> <span class="n">flood</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject_match</span><span class="p">(</span><span class="n">pop_raster</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">bilinear</span><span class="p">)</span>
            <span class="n">flood_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">flood_aligned</span> <span class="o">&gt;</span> <span class="n">FLOOD_THRESHOLD</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
            <span class="n">flooded_pop</span> <span class="o">=</span> <span class="n">pop_raster</span> <span class="o">*</span> <span class="n">flood_mask</span>

            <span class="n">tmp_flooded</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;tmp_flooded_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">_RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">.tif&quot;</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pop_raster_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compress</span><span class="o">=</span><span class="s2">&quot;lzw&quot;</span><span class="p">,</span> <span class="n">tiled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">bigtiff</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmp_flooded</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">flooded_pop</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">tmp_flooded</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>

            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed flooded population for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> &gt;</span><span class="si">{</span><span class="n">FLOOD_THRESHOLD</span><span class="si">}</span><span class="s2"> m (</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># ---- Flooded facilities ----</span>
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">geojsons_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="n">facilities</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">facilities</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">facilities</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;Point&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">facilities</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">flood</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                    <span class="n">facilities</span> <span class="o">=</span> <span class="n">facilities</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">flood</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facilities</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">centroid</span>
            <span class="k">if</span> <span class="n">facilities</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">flood</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="n">facilities</span> <span class="o">=</span> <span class="n">facilities</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">flood</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

            <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facilities</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">facilities</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">clipped_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>
            <span class="n">facilities</span><span class="p">[</span><span class="s2">&quot;flooded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">FLOOD_THRESHOLD</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

            <span class="n">joined</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
                <span class="n">facilities</span><span class="p">,</span> <span class="n">gdf</span><span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;within&quot;</span>
            <span class="p">)</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">)[</span><span class="s2">&quot;flooded&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="n">grouped</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">grouped</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">grouped</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">])</span>

            <span class="n">rp_df</span> <span class="o">=</span> <span class="n">rp_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">grouped</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_pct&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">_count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed flooded facilities for </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2"> &gt;</span><span class="si">{</span><span class="n">FLOOD_THRESHOLD</span><span class="si">}</span><span class="s2"> m (</span><span class="si">{</span><span class="n">THRESH_SUFFIX</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">final_df</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rp_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">admin_level</span><span class="si">}</span><span class="s2">_PCODE&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed RP</span><span class="si">{</span><span class="n">rp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">final_df</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">numeric_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flooded population &amp; facilities CSV written to </span><span class="si">{</span><span class="n">out_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_csv</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details><hr class="docutils" />
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/GIS_AA"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="en_qgis_generate_indicators_for_plugin.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">How to generate Risk Indicators</p>
      </div>
    </a>
    <a class="right-next"
       href="en_qgis_historical_impact_assessment_sudan.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Historical Impact Assessment (HIA) for Flood in Sudan</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-countries">Available Countries:</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-assessment-plugin">Risk Assessment Plugin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-to-services">1. Access to Services</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-sources">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-steps">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#outputs">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#facilities">2. Facilities</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coping-capacity">3. Coping Capacity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demographics">4. Demographics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#indicators">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rural-population">5. Rural Population</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vulnerability">6. Vulnerability</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crop-coverage-and-change">7. Crop Coverage and Change</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vegetation-index">8. Vegetation Index</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ndvi-thresholds">NDVI Thresholds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Outputs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flood-exposure">9. Flood Exposure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Data Sources</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Indicators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flood-threshold">Flood Threshold</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Processing Steps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Outputs</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By HeiGIT gGmbH
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright HeiGIT gGmbH.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <script data-goatcounter="https://gtrc.goatcounter.com/count"
async src="//gc.zgo.at/count.js"></script>
<p>
This project is released under a <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en">Creative Commons BY-NC-SA 4.0 license</a>, except where otherwise noted. Figures are subject to their original copyright and are not covered by this license.
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>